---
title: ã€æ–‡ç« ç¿»è­¯ã€‘Testable Flutter and Cloud Firestore
tags:
  - dependency-injection
  - flutter
  - firebase
  - cloud-firestore
  - testing
comments: true
categories:
  - Flutter
abbrlink: f22b27a6
date: 2020-10-15 19:34:38
---

ã€æ–‡ç« å…§å®¹ä½¿ç”¨ Gemini 1.5 Pro è‡ªå‹•ç”¢ç”Ÿã€‘

<figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*pQJzBr81G169df-ffo24Cg.png" /></figure>

### ç‚ºä»€éº¼é¸æ“‡ Cloud Firestoreï¼Ÿ

[FlutterFire](https://firebase.flutter.dev/) æŠ€è¡“å †ç–Šï¼Œç”± Flutter å’Œ Firebaseï¼ˆç‰¹åˆ¥æ˜¯ Cloud Firestoreï¼‰çµ„æˆï¼Œåœ¨æ‚¨æ§‹å»ºå’Œç™¼ä½ˆæ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œç‚ºæ‚¨è§£é–äº†å‰æ‰€æœªæœ‰çš„é–‹ç™¼é€Ÿåº¦ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°‡æ¢ç´¢é€™å…©ç¨®æŠ€è¡“ä¹‹é–“çš„å¼·å¤§æ•´åˆï¼Œé‡é»é—œæ³¨æ¸¬è©¦å’Œä½¿ç”¨ä¹¾æ·¨çš„æ¶æ§‹æ¨¡å¼ã€‚ä½†æ˜¯ï¼Œæ‚¨å°‡ä¸€æ­¥ä¸€æ­¥åœ°æ§‹å»ºè‡ªå·±çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç›´æ¥è·³åˆ°æœ€çµ‚å¯¦ä½œï¼Œé€™æ¨£æ¯å€‹æ­¥é©ŸèƒŒå¾Œçš„ç†ç”±å°±æ¸…æ™°æ˜ç­ã€‚

### æ‚¨å°‡æ§‹å»ºä»€éº¼ï¼Ÿ

ç‚ºäº†å±•ç¤ºå°‡ Cloud Firestore ä½œç‚ºæ‚¨æ‡‰ç”¨ç¨‹å¼å¾Œç«¯çš„ä¹¾æ·¨æ–¹æ³•ï¼Œæ‚¨å°‡æ§‹å»ºç¶“å…¸ Flutter è¨ˆæ•¸å™¨æ‡‰ç”¨ç¨‹å¼çš„ä¿®æ”¹ç‰ˆæœ¬ã€‚å”¯ä¸€çš„å€åˆ¥æ˜¯ï¼Œæ¯æ¬¡é»æ“Šçš„æ™‚é–“æˆ³éƒ½å„²å­˜åœ¨ Cloud Firestore ä¸­ï¼Œä¸¦ä¸”é¡¯ç¤ºçš„è¨ˆæ•¸æ˜¯å¾å„²å­˜çš„æ™‚é–“æˆ³çš„æ•¸é‡ä¸­æ¨å°å‡ºä¾†çš„ã€‚æ‚¨å°‡ä½¿ç”¨ Provider å’Œ ChangeNotifier ä¿æŒä¾è³´é …å’Œç‹€æ…‹ç®¡ç†ç¨‹å¼ç¢¼ä¹¾æ·¨ï¼Œä¸¦ä¸”æ‚¨å°‡æ›´æ–°ç”Ÿæˆçš„æ¸¬è©¦ä»¥ä¿æŒç¨‹å¼ç¢¼çš„ *æ­£ç¢ºæ€§*ï¼

### é–‹å§‹ä¹‹å‰

æœ¬æ–‡å‡è¨­æ‚¨å·² [è§€çœ‹ä¸¦æŒ‰ç…§æ­¤æ•™å­¸ä¸­çš„æ­¥é©Ÿæ“ä½œ](https://www.youtube.com/watch?v=Mx24wiPilHg) å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼èˆ‡ Firebase æ•´åˆã€‚ç°¡è¦èªªæ˜ä¸€ä¸‹ï¼š

1. å»ºç«‹ä¸€å€‹æ–°çš„ Flutter å°ˆæ¡ˆï¼Œä¸¦å‘½åç‚º firebasecounterã€‚
2. åœ¨ [Firebase ä¸»æ§å°](https://console.firebase.google.com/) ä¸­å»ºç«‹ä¸€å€‹ Firebase æ‡‰ç”¨ç¨‹å¼ã€‚
3. å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼é€£çµåˆ° iOS å’Œ/æˆ– Androidï¼Œå…·é«”å–æ±ºæ–¼æ‚¨çš„é–‹ç™¼ç’°å¢ƒå’Œç›®æ¨™å—çœ¾ã€‚

<blockquote>æ³¨æ„ï¼šå¦‚æœæ‚¨å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼è¨­å®šç‚ºåœ¨ Android å®¢æˆ¶ç«¯ä¸Šé‹è¡Œï¼Œè«‹å‹™å¿… [å»ºç«‹ä¸€å€‹ `debug.keystore` æª”æ¡ˆ](https://gist.github.com/henriquemenezes/70feb8fff20a19a65346e48786bedb8f)ï¼Œç„¶å¾Œå†ç”Ÿæˆæ‚¨çš„ SHA1 æ†‘è­‰ã€‚</blockquote>

åœ¨æ‚¨åœ¨ Firebase ä¸­ç”Ÿæˆ iOS æˆ– Android æ‡‰ç”¨ç¨‹å¼ä¹‹å¾Œï¼Œæ‚¨å°±å¯ä»¥ç¹¼çºŒé€²è¡Œã€‚å½±ç‰‡çš„å…¶é¤˜éƒ¨åˆ†åŒ…å«æ‚¨åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½éœ€è¦çš„ç²¾å½©å…§å®¹ï¼Œä½†å°æ–¼æœ¬æ•™å­¸ä¾†èªªä¸æ˜¯å¿…éœ€çš„ã€‚

### å¦‚æœæ‚¨é‡åˆ°å•é¡Œ

å¦‚æœæœ¬æ•™å­¸ä¸­çš„ä»»ä½•æ­¥é©Ÿå°æ‚¨ä¸èµ·ä½œç”¨ï¼Œè«‹è«®è©¢ [é€™å€‹å…¬é–‹çš„å„²å­˜åº«](https://github.com/craiglabenz/flutter-firestore-counter)ï¼Œå®ƒå°‡æ›´æ”¹åˆ†è§£ç‚ºä¸åŒçš„æäº¤ã€‚åœ¨æ•´å€‹æ•™å­¸ä¸­ï¼Œæ‚¨å°‡åœ¨é©ç•¶çš„ä½ç½®æ‰¾åˆ°æŒ‡å‘æ¯å€‹æäº¤çš„é€£çµã€‚è«‹éš¨æ™‚ä½¿ç”¨å®ƒä¾†é©—è­‰æ‚¨æ˜¯å¦å·²æŒ‰ç…§é æœŸçš„æ–¹å¼é€²è¡Œï¼

### å»ºç«‹ä¸€å€‹ç°¡å–®çš„ç‹€æ…‹ç®¡ç†å“¡

è¦é–‹å§‹å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼èˆ‡ Cloud Firestore æ•´åˆçš„éç¨‹ï¼Œæ‚¨å¿…é ˆé¦–å…ˆé‡æ§‹ç”Ÿæˆçš„ç¨‹å¼ç¢¼ï¼Œä»¥ä¾¿åˆå§‹ StatefulWidget èˆ‡å–®ç¨çš„é¡åˆ¥é€²è¡Œé€šè¨Šï¼Œè€Œä¸æ˜¯èˆ‡è‡ªèº«çš„å±¬æ€§é€²è¡Œé€šè¨Šã€‚é€™è®“æ‚¨æœ€çµ‚å¯ä»¥æŒ‡ç¤ºè©²å–®ç¨çš„é¡åˆ¥ä½¿ç”¨ Cloud Firestoreã€‚

åœ¨æ‚¨çš„å°ˆæ¡ˆçš„è‡ªå‹•ç”Ÿæˆçš„ `main.dart` æª”æ¡ˆæ—é‚Šï¼Œå»ºç«‹ä¸€å€‹åç‚º `counter_manager.dart` çš„æ–°æª”æ¡ˆï¼Œä¸¦å°‡ä»¥ä¸‹ç¨‹å¼ç¢¼è¤‡è£½åˆ°å…¶ä¸­ï¼š

```dart
class CounterManager {
  /// å»ºç«‹ä¸€å€‹ç§æœ‰æ•´æ•¸ä¾†å„²å­˜è¨ˆæ•¸ã€‚å°‡å…¶è¨­ç‚ºç§æœ‰ï¼Œ
  /// å› æ­¤ Widget ç„¡æ³•ç›´æ¥ä¿®æ”¹å®ƒï¼Œè€Œæ˜¯å¿…é ˆ
  /// ä½¿ç”¨å®˜æ–¹æ–¹æ³•ã€‚
  int _count = 0;

  /// å…¬é–‹å¯å­˜å–çš„ç‹€æ…‹åƒè€ƒã€‚
  int get count => _count;

  /// å…¬é–‹å¯å­˜å–çš„ç‹€æ…‹ä¿®æ”¹å™¨ã€‚
  void increment() => _count++;
}
```

åœ¨ç¨‹å¼ç¢¼å°±ä½å¾Œï¼Œå°‡ä»¥ä¸‹è¡Œæ–°å¢åˆ° `firebasecounter/lib/main.dart` çš„é ‚éƒ¨ï¼š

```dart
import 'package:firebasecounter/counter_manager.dart';
```

ç„¶å¾Œï¼Œå°‡ `_MyHomePageState` çš„ç¨‹å¼ç¢¼æ›´æ”¹ç‚ºä»¥ä¸‹å…§å®¹ï¼š

```dart
class _MyHomePageState extends State<MyHomePage> {
  final manager = CounterManager();

  void _incrementCounter() {
    setState(() => manager.increment());
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            Text('You have pushed the button this many times:'),
            Text(
              '${manager.count}',
              style: Theme.of(context).textTheme.headline4,
            ),
          ],
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _incrementCounter,
        tooltip: 'Increment',
        child: Icon(Icons.add),
      ),
    );
  }
}
```

å„²å­˜æ­¤ç¨‹å¼ç¢¼æ›´æ”¹å¾Œï¼Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼å¯èƒ½æœƒé¡¯ç¤ºå´©æ½°ä¸¦é¡¯ç¤ºä¸€å€‹ç´…è‰²çš„éŒ¯èª¤è¢å¹•ã€‚é€™æ˜¯å› ç‚ºæ‚¨å¼•å…¥äº†ä¸€å€‹æ–°çš„è®Šæ•¸ `manager`ï¼Œå®ƒåˆå§‹åŒ–çš„æ©Ÿæœƒå·²ç¶“éäº†ã€‚ç•¶æ‚¨æ›´æ”¹ç‹€æ…‹çš„ *åˆå§‹åŒ–æ–¹å¼* æ™‚ï¼Œé€™åœ¨ Flutter ä¸­å¾ˆå¸¸è¦‹ï¼Œä¸¦ä¸”å¯ä»¥ä½¿ç”¨ç†±é‡æ–°å•Ÿå‹•è¼•é¬†è§£æ±ºã€‚

ç†±é‡æ–°å•Ÿå‹•å¾Œï¼Œæ‚¨æ‡‰è©²å›åˆ°é–‹å§‹çš„åœ°æ–¹ï¼šè¨ˆæ•¸ç‚º 0ï¼Œä¸¦ä¸”å¯ä»¥æ ¹æ“šéœ€è¦é»æ“Šæµ®å‹•å‹•ä½œæŒ‰éˆ•ã€‚

ç¾åœ¨æ˜¯é‹è¡Œ Flutter åœ¨ä»»ä½•æ–°çš„å°ˆæ¡ˆä¸­æä¾›çš„å–®ä¸€æ¸¬è©¦çš„å¥½æ™‚æ©Ÿã€‚æ‚¨å¯ä»¥åœ¨ `test/widget_test.dart` ä¸­æ‰¾åˆ°å®ƒçš„å®šç¾©ï¼Œä¸¦é€éé‹è¡Œä»¥ä¸‹å‘½ä»¤åŸ·è¡Œå®ƒï¼š

```bash
$ flutter test
```

å‡è¨­æ¸¬è©¦é€šéï¼Œæ‚¨å°±å¯ä»¥ç¹¼çºŒé€²è¡Œï¼

<blockquote>æ³¨æ„ï¼šå¦‚æœæ‚¨åœ¨æ­¤éƒ¨åˆ†é‡åˆ°å•é¡Œï¼Œè«‹å°‡æ‚¨çš„æ›´æ”¹èˆ‡æ•™å­¸å„²å­˜åº«ä¸­çš„ [é€™å€‹æäº¤](https://github.com/craiglabenz/flutter-firestore-counter/commit/483dd3b3833bf710b04db4a3ba347b1d1ecbe5de) é€²è¡Œæ¯”è¼ƒã€‚</blockquote>

### æŒçºŒæ™‚é–“æˆ³

åˆå§‹æ‡‰ç”¨ç¨‹å¼æè¿°ä¸­æåˆ°äº†æŒçºŒå„²å­˜æ¯æ¬¡é»æ“Šçš„æ™‚é–“æˆ³ã€‚åˆ°ç›®å‰ç‚ºæ­¢ï¼Œæ‚¨å°šæœªæ·»åŠ ä»»ä½•åŸºç¤æ¶æ§‹ä¾†æ»¿è¶³ç¬¬äºŒå€‹è¦æ±‚ï¼Œå› æ­¤è«‹å»ºç«‹å¦ä¸€å€‹åç‚º `app_state.dart` çš„æ–°æª”æ¡ˆï¼Œä¸¦æ·»åŠ ä»¥ä¸‹é¡åˆ¥ï¼š

```dart
/// æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹çš„å®Œæ•´å®¹å™¨ã€‚
/// æ­¤é¡åˆ¥çš„å¯¦ä¾‹æ‡‰è©²èƒ½å¤ å‘ŠçŸ¥ä»»ä½•æ™‚å€™
/// æ¸²æŸ“çš„å…§å®¹ã€‚
class AppState {
  /// å®Œæ•´çš„é»æ“Šæ­·å²è¨˜éŒ„ã€‚ç”¨æ–¼éå¸¸é‡è¦çš„å¯©è¨ˆç›®çš„ã€‚
  /// é»æ“Šçš„è¨ˆæ•¸è®Šç‚ºæ­¤åˆ—è¡¨çš„ `length` å±¬æ€§ã€‚
  final List<DateTime> clicks;

  /// é è¨­ç”Ÿæˆå¼å»ºæ§‹å‡½å¼ã€‚å°å¸¸æ•¸å‹å¥½ï¼Œä»¥å¯¦ç¾æœ€ä½³
  /// æ•ˆèƒ½ã€‚
  const AppState([List<DateTime> clicks])
      : clicks = clicks ?? const <DateTime>[];

  /// æ–¹ä¾¿çš„è¼”åŠ©å‡½å¼ã€‚
  int get count => clicks.length;

  /// è¤‡è£½æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€å€‹æ–°çš„ AppState å¯¦ä¾‹ï¼Œè€Œä¸æ˜¯
  /// ä¿®æ”¹ç¾æœ‰çš„å‰¯æœ¬ã€‚
  AppState copyWith(DateTime latestClick) => AppState([
        latestClick,
        ...clicks,
      ]);
}
```

å¾ç¾åœ¨é–‹å§‹ï¼Œ`AppState` é¡åˆ¥çš„å·¥ä½œæ˜¯è¡¨ç¤ºæ‡‰è©²æ¸²æŸ“çš„å…§å®¹çš„ç‹€æ…‹ã€‚è©²é¡åˆ¥ä¸åŒ…å«ä»»ä½•å¯ä»¥ä¿®æ”¹è‡ªèº«çš„æ–¹æ³•ï¼Œåªæœ‰ä¸€å€‹å–®ç¨çš„ `copyWith` æ–¹æ³•ï¼Œå…¶ä»–é¡åˆ¥å°‡ä½¿ç”¨å®ƒã€‚

ç‰¢è¨˜æ¸¬è©¦ï¼Œæ‚¨å¯ä»¥é–‹å§‹æ›´æ”¹ `CounterManager` æ¦‚å¿µã€‚å¾é•·é ä¾†çœ‹ï¼Œä½¿ç”¨å–®ä¸€é¡åˆ¥å°‡è¡Œä¸é€šï¼Œå› ç‚ºæ‡‰ç”¨ç¨‹å¼æœ€çµ‚æœƒèˆ‡ Cloud Firestore é€²è¡Œäº’å‹•ã€‚ä½†æ˜¯ï¼Œæ‚¨ä¸æƒ³åœ¨æ¯æ¬¡é‹è¡Œæ¸¬è©¦æ™‚éƒ½å»ºç«‹çœŸå¯¦çš„è¨˜éŒ„ã€‚ç‚ºæ­¤ï¼Œæ‚¨éœ€è¦ä¸€å€‹æŠ½è±¡ä»‹é¢ä¾†å®šç¾©æ‡‰ç”¨ç¨‹å¼æ‡‰è©²å¦‚ä½•è¡¨ç¾ã€‚

å†æ¬¡æ‰“é–‹ `counter_manager.dart`ï¼Œä¸¦åœ¨æª”æ¡ˆçš„é ‚éƒ¨æ·»åŠ ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```dart
import 'package:firebasecounter/app_state.dart';

/// å®šç¾©æ“ä½œ
/// æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹æ‰€éœ€çš„å‡½å¼çš„ä»‹é¢ã€‚
///
/// å®šç¾©ç‚ºæŠ½è±¡é¡åˆ¥ï¼Œä»¥ä¾¿æ¸¬è©¦å¯ä»¥åœ¨ä¸
/// èˆ‡ Firebase é€šè¨Šçš„ç‰ˆæœ¬ä¸Šé‹è¡Œã€‚
abstract class ICounterManager {
  /// ä»»ä½• `CounterManager` éƒ½å¿…é ˆå…·æœ‰ç‹€æ…‹çš„å¯¦ä¾‹
  /// ç‰©ä»¶ã€‚
  AppState state;

  /// è™•ç†å¿…é ˆå„²å­˜æ–°çš„é»æ“Šçš„äº‹ä»¶ã€‚ä¸éœ€è¦
  /// ä»»ä½•åƒæ•¸ï¼Œå› ç‚ºå®ƒåªæœƒå°è‡´æ™‚é–“æˆ³
  /// æŒçºŒå­˜åœ¨ã€‚
  void increment();
}
```

ä¸‹ä¸€æ­¥æ˜¯æ›´æ–° `CounterManager` ä»¥é¡¯å¼åœ°å¾ `ICounterManager` ç¹¼æ‰¿ã€‚å°‡å…¶å®šç¾©æ›´æ–°ç‚ºä»¥ä¸‹å…§å®¹ï¼š

```dart
class CounterManager implements ICounterManager {
  AppState state = AppState();

  void increment() => state = state.copyWith(DateTime.now());
}
```

åœ¨é€™å€‹éšæ®µï¼Œæˆ‘å€‘çš„è¼”åŠ©ç¨‹å¼ç¢¼çœ‹èµ·ä¾†å·²ç¶“å¾ˆå¥½äº†ï¼Œä½†æ˜¯ `main.dart` è½å¾Œäº†ã€‚`main.dart` ä¸­æ²’æœ‰ `ICounterManager` çš„åƒè€ƒï¼Œè€Œäº‹å¯¦ä¸Šï¼Œå®ƒæ˜¯å®ƒæ‡‰è©²çŸ¥é“çš„ *å”¯ä¸€* çš„ `Manager` é¡åˆ¥ã€‚åœ¨ `main.dart` ä¸­ï¼Œæ›´æ–°ä¸¦æ‡‰ç”¨ä»¥ä¸‹æ›´æ”¹ï¼š

1. å°‡éºæ¼çš„åŒ¯å…¥æ–°å¢åˆ° `main.dart` çš„é ‚éƒ¨ï¼š

```dart
import 'package:firebasecounter/app_state.dart';
```

2. å°‡ `_MyHomePageState` æ›´æ–°ç‚ºä»¥ä¸‹å…§å®¹ï¼š

```dart
class _MyHomePageState extends State<MyHomePage> {
  final ICounterManager manager;
  _MyHomePageState({@required this.manager});

  void _incrementCounter() => setState(() => manager.increment());

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            Text('You have pushed the button this many times:'),
            Text(
              // åƒè€ƒ `widget.manager` è€Œä¸æ˜¯
              // `manager` ç›´æ¥
              '${manager.state.count}',
              style: Theme.of(context).textTheme.headline4,
            ),
          ],
        ),
      ),
      floatingActionButton: FloatingActionButton(
        // åƒè€ƒ `widget.manager` è€Œä¸æ˜¯ `manager` ç›´æ¥
        onPressed: _incrementCounter,
        tooltip: 'Increment',
        child: Icon(Icons.add),
      ),
    );
  }
}
```

æ­¤æ›´æ”¹æ‡‰è©²æœƒç§»é™¤ IDE ä¸­ `_MyHomePageState` çš„ä»»ä½•ç´…è‰²æ³¢æµªç·šï¼Œä½†æ˜¯ç¾åœ¨ `MyHomePage` æœƒæŠ±æ€¨ï¼Œå› ç‚ºå®ƒçš„ `createState()` æ–¹æ³•æ²’æœ‰å‘ `_MyHomePageState` æä¾›æ‰€æœ‰å¿…éœ€çš„åƒæ•¸ã€‚æ‚¨å¯ä»¥è®“ `MyHomePage` è¦æ±‚æ­¤è®Šæ•¸ï¼Œä¸¦å°‡ç‰©ä»¶å‚³éåˆ°å®ƒçš„åŸºæ–¼ç‹€æ…‹çš„é¡åˆ¥ï¼Œä½†æ˜¯é€™å¯èƒ½æœƒå°è‡´å¾ˆé•·çš„ Widget éˆï¼Œé€™äº› Widget æœƒè¦æ±‚ä¸¦å‚³éå®ƒå€‘å¯¦éš›ä¸Šä¸åœ¨ä¹çš„ç‰©ä»¶ï¼Œåƒ…åƒ…å› ç‚ºæŸäº›å¾Œä»£ Widget è¦æ±‚å®ƒï¼Œè€ŒæŸäº›ç¥–å…ˆ Widget æä¾›å®ƒã€‚é¡¯ç„¶ï¼Œé€™éœ€è¦ä¸€å€‹æ›´å¥½çš„ç­–ç•¥ã€‚

è¼¸å…¥ï¼š [Provider](https://pub.dev/packages/provider)

### ä½¿ç”¨ Provider å­˜å–æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹

Provider æ˜¯ä¸€ä¸ªå‡½å¼åº«ï¼Œå®ƒç®€åŒ–äº† Flutter çš„ `InheritedWidget` æ¨¡å¼çš„ä½¿ç”¨ã€‚Provider å…è¨±é ‚ç´š Widget åœ¨æ‚¨çš„ Widget æ¨¹ä¸­è¢«æ‰€æœ‰å¾Œä»£ Widget ç›´æ¥å­˜å–ã€‚é€™å¯èƒ½æ„Ÿè¦ºåƒä¸€å€‹å…¨åŸŸè®Šæ•¸ï¼Œä½†æ›¿ä»£æ–¹æ¡ˆæ˜¯å°‡æ‚¨çš„è³‡æ–™æ¨¡å‹é€éæ¯å€‹ä¸­é–“ Widget å‚³éä¸‹å»ï¼Œå…¶ä¸­è¨±å¤š Widget æœ¬èº«ä¸¦ä¸æ„Ÿèˆˆè¶£ã€‚é€™ç¨®ã€Œè®Šæ•¸ [æ¡¶å¼å‚³é](https://en.wikipedia.org/wiki/Bucket_brigade)ã€åæ¨¡å¼æœƒæ¨¡ç³Šæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­çš„é—œæ³¨é»åˆ†é›¢ï¼Œä¸¦ä¸”æœƒä½¿é‡æ§‹ä½ˆå±€è®Šå¾—ä¸å¿…è¦åœ°ç¹ç‘£ã€‚`InheritedWidget` å’Œ Provider é€éè®“ Widget æ¨¹ä¸­çš„ä»»ä½•ä½ç½®çš„ Widget éƒ½å¯ä»¥ç›´æ¥ç²å–æ‰€éœ€çš„è³‡æ–™æ¨¡å‹ä¾†é¿å…é€™äº›å•é¡Œã€‚

è¦å°‡ Provider æ·»åŠ åˆ°æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ï¼Œè«‹æ‰“é–‹ `pubspec.yaml`ï¼Œä¸¦åœ¨ `dependencies` å€æ®µä¸­æ·»åŠ å®ƒï¼š

```yaml
dependencies:
  flutter:
    sdk: flutter
  # Add this
  provider: ^4.3.2+2
```

åœ¨å°‡è©²è¡Œæ·»åŠ åˆ°æ‚¨çš„ `pubspec.yaml` æª”æ¡ˆå¾Œï¼Œé‹è¡Œä»¥ä¸‹å‘½ä»¤å°‡ Provider ä¸‹è¼‰åˆ°æ‚¨çš„æ©Ÿå™¨ä¸Šï¼š

```bash
$ flutter pub get
```

åœ¨ `main.dart` æ—é‚Šï¼Œå»ºç«‹ä¸€å€‹åç‚º `dependencies.dart` çš„æ–°æª”æ¡ˆï¼Œä¸¦å°‡ä»¥ä¸‹ç¨‹å¼ç¢¼è¤‡è£½åˆ°å…¶ä¸­ï¼š

```dart
import 'package:firebasecounter/counter_manager.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

class DependenciesProvider extends StatelessWidget {
  final Widget child;
  DependenciesProvider({@required this.child});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        Provider<ICounterManager>(create: (context) => CounterManager()),
      ],
      child: child,
    );
  }
}
```

é—œæ–¼ `DependenciesProvider` çš„ä¸€äº›æ³¨æ„äº‹é …ï¼š

1. å®ƒä½¿ç”¨ `MultiProvider`ï¼Œå„˜ç®¡å®ƒçš„åˆ—è¡¨ä¸­åªæœ‰ä¸€å€‹æ¢ç›®ã€‚å¾æŠ€è¡“ä¸Šè¬›ï¼Œé€™å¯ä»¥æ‘ºç–Šç‚ºä¸€å€‹å–®ç¨çš„ `Provider` Widgetï¼Œä½†æ˜¯å¯¦éš›çš„æ‡‰ç”¨ç¨‹å¼å¯èƒ½æœƒåŒ…å«è¨±å¤šé€™æ¨£çš„æœå‹™ï¼Œå› æ­¤æœ€å¥½å¾ä¸€é–‹å§‹å°±ä½¿ç”¨ `MultiProvider`ã€‚
2. å®ƒéœ€è¦ä¸€å€‹å­ Widgetï¼Œå®ƒéµå¾ª Flutter ä¸­ Widget çµ„åˆçš„æ…£ä¾‹ï¼Œå…è¨±æˆ‘å€‘å°‡æ­¤è¼”åŠ©ç¨‹å¼ç¢¼æ’å…¥ Widget æ¨¹çš„é ‚éƒ¨ï¼Œå¾è€Œä½¿ `ICounterManager` å¯¦ä¾‹å¯ç”¨æ–¼æ•´å€‹æ‡‰ç”¨ç¨‹å¼ã€‚

æ¥ä¸‹ä¾†ï¼Œè®“æ–°çš„ `DependenciesProvider` å¯ç”¨æ–¼æ•´å€‹æ‡‰ç”¨ç¨‹å¼ã€‚ä¸€ç¨®ç°¡å–®çš„æ–¹æ³•æ˜¯ä½¿ç”¨å®ƒä¾†åŒ…è£æ•´å€‹ `MaterialApp` Widgetã€‚æ‰“é–‹ `main.dart`ï¼Œä¸¦å°‡ `main` æ–¹æ³•æ›´æ–°ç‚ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```dart
void main() {
  runApp(
    DependenciesProvider(child: MyApp()),
  );
}
```

æ‚¨é‚„éœ€è¦åœ¨ `main.dart` ä¸­åŒ¯å…¥ `dependencies.dart`ï¼š

```dart
import 'package:firebasecounter/dependencies.dart';
```

### ä½¿ç”¨ Consumer Widget

æ‚¨å·²ç¶“çœ‹åˆ°äº† `MultiProvider` Widget çš„ä½œç”¨ï¼ˆå¯¦éš›ä¸Šå®ƒåªæ˜¯ä¸€ç¨®å®£å‘Šä¸€ç³»åˆ—å–®ç¨çš„ `Provider` Widget çš„æ›´ä¾¿æ·æ–¹å¼ï¼‰ã€‚ä¸‹ä¸€æ­¥æ˜¯é€éä½¿ç”¨ [Consumer](https://pub.dev/documentation/provider/latest/provider/Consumer-class.html) Widget ä¾†å­˜å– `ICounterManager` ç‰©ä»¶ã€‚

### ä¾è³´æ³¨å…¥

å¦‚æœæ‚¨ä½¿ç”¨é Cloud Firestore æ’°å¯«é Flutter æ‡‰ç”¨ç¨‹å¼ï¼Œé‚£éº¼æ‚¨å¯èƒ½æœƒç™¼ç¾ Firestore æœƒè®“å–®å…ƒæ¸¬è©¦æ›´é›£æ’°å¯«ã€‚ç•¢ç«Ÿï¼Œç•¶ Firestore æ•´åˆç›´æ¥é€£æ¥åˆ°æ‚¨çš„ Widget æ¨¹ä¸­æ™‚ï¼Œæ‚¨å¦‚ä½•é¿å…åœ¨è³‡æ–™åº«ä¸­ç”ŸæˆçœŸå¯¦çš„è¨˜éŒ„ï¼Ÿ

å¦‚æœæ‚¨æœ‰éé€™ç¨®é«”é©—ï¼Œé‚£éº¼æ‚¨å°±æœƒç™¼ç¾å°‡ä¾è³´é …ç›´æ¥çƒ˜ç„™åˆ° UI ç¨‹å¼ç¢¼ä¸­çš„å±€é™æ€§ï¼Œåœ¨ Flutter çš„æƒ…æ³ä¸‹ï¼ŒUI ç¨‹å¼ç¢¼æ˜¯ Widgetã€‚é€™å°±æ˜¯ä¾è³´æ³¨å…¥çš„å¼·å¤§ä¹‹è™•ï¼šå¦‚æœæ‚¨çš„ Widget æ¥å—è¼”åŠ©é¡åˆ¥ï¼Œé€™äº›è¼”åŠ©é¡åˆ¥ä¿ƒé€²å®ƒå€‘èˆ‡ä¾è³´é …ï¼ˆå¦‚ Firebaseã€è¨­å‚™çš„æª”æ¡ˆç³»çµ±ï¼Œç”šè‡³ç¶²è·¯è«‹æ±‚ï¼‰çš„äº’å‹•ï¼Œé‚£éº¼æ‚¨å¯ä»¥åœ¨æ¸¬è©¦æœŸé–“æä¾›æ¨¡æ“¬æˆ–å½é€ ç‰©ä»¶ï¼Œè€Œä¸æ˜¯çœŸå¯¦çš„é¡åˆ¥ã€‚é€™è®“æ‚¨å¯ä»¥æ¸¬è©¦ Widget æ˜¯å¦æŒ‰é æœŸå·¥ä½œï¼Œè€Œç„¡éœ€ç­‰å¾…ç·©æ…¢çš„ç¶²è·¯è«‹æ±‚ã€å¡«æ»¿æª”æ¡ˆç³»çµ±æˆ–ç”¢ç”Ÿ Firebase è¨ˆè²»è²»ç”¨ã€‚

è¦å¯¦ç¾é€™ä¸€é»ï¼Œæ‚¨éœ€è¦é‡æ§‹æ‡‰ç”¨ç¨‹å¼ï¼Œä»¥ä¾¿æœ‰ä¸€å€‹æ¸…æ™°çš„é»ï¼Œè®“æ¸¬è©¦å¯ä»¥æ³¨å…¥æ¨¡æ“¬çœŸå¯¦ Cloud Firestore è¡Œç‚ºçš„å½é€ ç‰©ä»¶ã€‚å¹¸é‹çš„æ˜¯ï¼Œ`Consumer` Widget éå¸¸é©åˆæ­¤å·¥ä½œã€‚

æ‰“é–‹ `main.dart`ï¼Œä¸¦å°‡æ‚¨çš„ `MyApp` Widget æ›¿æ›ç‚ºä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```dart
// åœ¨é ‚éƒ¨æ·»åŠ æ­¤åŒ¯å…¥
import 'package:firebasecounter/firebase_waiter.dart';

// å°‡ `MyApp` æ›¿æ›ç‚ºæ­¤
class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Demo',
      theme: ThemeData(
        primarySwatch: Colors.blue,
        visualDensity: VisualDensity.adaptivePlatformDensity,
      ),
      home: FirebaseWaiter(
        builder: (context) => Consumer<ICounterManager>(
          builder: (context, manager, _child) => MyHomePage(
            manager: manager,
            title: 'Flutter Demo Home Page',
          ),
        ),
        // é€™æ˜¯æ”¾ç½®æ‚¨çš„å•Ÿå‹•é é¢çš„å¥½åœ°æ–¹ï¼
        waitingChild: Scaffold(
          body: const Center(child: CircularProgressIndicator()),
        ),
      ),
    );
  }
}
```

æ­¤å¤–ï¼Œåœ¨ `main.dart` çš„é ‚éƒ¨åŒ¯å…¥ `Provider`ï¼š

```dart
import 'package:provider/provider.dart';
```

å°‡ `MyHomePage` åŒ…è£¹åœ¨ `Consumer` Widget ä¸­ï¼Œå…è¨±æ‚¨åˆ°é” Widget æ¨¹ä¸­ä»»æ„é«˜çš„åœ°æ–¹ï¼Œä»¥å­˜å–æ‰€éœ€çš„è³‡æºï¼Œä¸¦å°‡å®ƒå€‘æ³¨å…¥åˆ°éœ€è¦å®ƒå€‘çš„ Widget ä¸­ã€‚åœ¨æœ¬æ•™å­¸ä¸­ï¼Œé€™å¯èƒ½æ„Ÿè¦ºæ²’æœ‰å¿…è¦çš„å·¥ä½œï¼Œå› ç‚ºæ‚¨åªå‘ä¸Šåˆ°é” `MyApp()` ä¸€å±¤ï¼Œä½†æ˜¯é€™åœ¨å¯¦éš›çš„ç”Ÿç”¢æ‡‰ç”¨ç¨‹å¼ä¸­å¯èƒ½æœƒé€éæ•¸åå€‹ Widget å»¶ä¼¸ã€‚

æ¥ä¸‹ä¾†ï¼Œåœ¨åŒä¸€å€‹æª”æ¡ˆä¸­ï¼Œå° `MyHomePage` é€²è¡Œä»¥ä¸‹ç·¨è¼¯ï¼š

<blockquote>æ³¨æ„ï¼šå¦‚æœåœ¨å„²å­˜æ­¤æ›´æ”¹å¾Œæ‚¨çœ‹åˆ°ç´…è‰²è¢å¹•ï¼Œè«‹ä¸è¦æ“”å¿ƒã€‚éœ€è¦æ›´å¤šç·¨è¼¯æ‰èƒ½å®Œæˆé‡æ§‹ï¼</blockquote>

```dart
class MyHomePage extends StatefulWidget {
  final ICounterManager manager;
  MyHomePage({@required this.manager, Key key, this.title}) : super(key: key);

  final String title;

  @override
  _MyHomePageState createState() => _MyHomePageState();
}
```

é€™å€‹ç°¡å–®çš„å»ºæ§‹å‡½å¼æ›´æ”¹å…è¨±ç¨‹å¼ç¢¼æ¥å—åœ¨å…ˆå‰ç¨‹å¼ç¢¼ç‰‡æ®µä¸­å‚³å…¥çš„è®Šæ•¸ã€‚

æœ€å¾Œï¼Œé€éå° `_MyHomePageState` é€²è¡Œä»¥ä¸‹ç·¨è¼¯ä¾†å®Œæˆé‡æ§‹ï¼š

```dart
class _MyHomePageState extends State<MyHomePage> {

  // ä¸å†æœŸæœ›æ¥æ”¶ `ICounterManager` ç‰©ä»¶

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(widget.title),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: <Widget>[
            Text('You have pushed the button this many times:'),
            Text(
              // åƒè€ƒ `widget.manager` è€Œä¸æ˜¯
              // `manager` ç›´æ¥
              '${widget.manager.state.count}',
              style: Theme.of(context).textTheme.headline4,
            ),
          ],
        ),
      ),
      floatingActionButton: FloatingActionButton(
        // åƒè€ƒ `widget.manager` è€Œä¸æ˜¯ `manager` ç›´æ¥
        onPressed: () => setState(() => widget.manager.increment()),
        tooltip: 'Increment',
        child: Icon(Icons.add),
      ),
    );
  }
}
```

<blockquote>æ³¨æ„ï¼šæ‚¨å¯èƒ½éœ€è¦åŸ·è¡Œç†±é‡æ–°å•Ÿå‹•ä¾†ä¿®å¾©æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€‚</blockquote>

å¦‚æ‚¨æ‰€çŸ¥ï¼Œæ‰€æœ‰ State ç‰©ä»¶éƒ½åŒ…å«å°å®ƒå€‘åœ¨ Widget å±¬æ€§ä¸­åŒ…å«çš„ StatefulWidget åŒ…è£¹å™¨çš„åƒè€ƒã€‚å› æ­¤ï¼Œ`_MyHomePageState` ç‰©ä»¶å¯ä»¥é€éå°‡å…¶ç¨‹å¼ç¢¼å¾ `manager` æ›´æ”¹ç‚º `widget.manager` ä¾†å­˜å–é€™å€‹æ–°çš„ `manager` å±¬æ€§ã€‚

å°±é€™æ¨£ï¼æ‚¨å·²ç¶“å°‡ä¾è³´é …æ³¨å…¥åˆ°éœ€è¦å®ƒå€‘çš„ Widget ä¸­ï¼Œè€Œä¸æ˜¯ç¡¬ç·¨ç¢¼ç”Ÿç”¢å¯¦ä½œã€‚

### æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼

å¦‚æœæ‚¨ç¾åœ¨é‹è¡Œ `flutter test`ï¼Œæ‚¨å°‡æœƒçœ‹åˆ°æ¸¬è©¦å¥—ä»¶ä¸å†é€šéã€‚ç•¶æ‚¨æª¢æŸ¥ `widget_test.dart` æ™‚ï¼ŒåŸå› å¯èƒ½å¾ˆæ¸…æ¥šï¼šæ¸¬è©¦å‡½å¼å¯¦ä¾‹åŒ–äº† `MyApp()`ï¼Œä½†æ²’æœ‰åƒæ‚¨åœ¨çœŸå¯¦ç¨‹å¼ç¢¼ä¸­æ‰€åšçš„é‚£æ¨£ç”¨ `DependenciesProvider` åŒ…è£¹å®ƒï¼Œå› æ­¤ `MyApp` ä¸­æ·»åŠ çš„ `Consumer` Widget ç„¡æ³•åœ¨å…¶ç¥–å…ˆ Widget ä¸­æ‰¾åˆ°æ»¿è¶³çš„ `Provider`ã€‚

é€™å°±æ˜¯ä¾è³´æ³¨å…¥é–‹å§‹ç™¼æ®ä½œç”¨çš„åœ°æ–¹ã€‚æ‚¨ä¸å¿…åœ¨æ¸¬è©¦ä¸­æ¨¡ä»¿ç”Ÿç”¢ç¨‹å¼ç¢¼ï¼ˆé€éå°‡ `MyApp` åŒ…è£¹åœ¨ `DependenciesProvider` ä¸­ï¼‰ï¼Œè€Œæ˜¯æ›´æ”¹æ¸¬è©¦ä»¥åˆå§‹åŒ– `MyHomePage`ã€‚å°‡ `widget_test.dart` æ›´æ–°ç‚ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```dart
import 'package:firebasecounter/counter_manager.dart';
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

import 'package:firebasecounter/main.dart';

void main() {
  testWidgets('Counter increments smoke test', (WidgetTester tester) async {
    // Build our app and trigger a frame.
    await tester.pumpWidget(
      MaterialApp(
        home: MyHomePage(
          manager: CounterManager(),
          title: 'Test Widget',
        ),
      ),
    );

    // Verify that our counter starts at 0.
    expect(find.text('0'), findsOneWidget);
    expect(find.text('1'), findsNothing);

    // Tap the '+' icon and trigger a frame.
    await tester.tap(find.byIcon(Icons.add));
    await tester.pump();

    // Verify that our counter has incremented.
    expect(find.text('0'), findsNothing);
    expect(find.text('1'), findsOneWidget);
  });
}
```

é€éç›´æ¥ä½¿ç”¨ `MyHomePage` å¯¦ä¾‹ï¼ˆä»¥åŠä¸€å€‹åŒ…è£çš„ `MaterialApp` ä¾†æä¾›æœ‰æ•ˆçš„ `BuildContext` ç‰©ä»¶ï¼‰ï¼Œæ‚¨å·²ç¶“ç‚ºè‡ªå·±å»ºç«‹äº†èˆ‡ Cloud Firestore çš„å–®å…ƒæ¸¬è©¦æ•´åˆï¼

<blockquote>æ³¨æ„ï¼šå¦‚æœæ‚¨åœ¨æ­¤éƒ¨åˆ†é‡åˆ°å•é¡Œï¼Œè«‹å°‡æ‚¨çš„æ›´æ”¹èˆ‡æ•™å­¸å„²å­˜åº«ä¸­çš„ [é€™å€‹æäº¤](https://github.com/craiglabenz/flutter-firestore-counter/commit/bb68c1d3bb3746eca5f2dea16bd799c98ff232f1) é€²è¡Œæ¯”è¼ƒã€‚</blockquote>

### å¯¦ä½œ Cloud Firestore

åˆ°ç›®å‰ç‚ºæ­¢ï¼Œæ‚¨å·²ç¶“ç§»å‹•äº†å¾ˆå¤šç¨‹å¼ç¢¼ï¼Œä¸¦å¼•å…¥äº†å¹¾å€‹è¼”åŠ©é¡åˆ¥ï¼Œä½†æ˜¯æ‚¨é‚„æ²’æœ‰æ›´æ”¹æ‡‰ç”¨ç¨‹å¼çš„ä»»ä½•å·¥ä½œæ–¹å¼ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œä¸€åˆ‡éƒ½å·²å°±ä½ï¼Œå¯ä»¥é–‹å§‹æ’°å¯«ä¸€äº›äº†è§£ Cloud Firestore çš„ç¨‹å¼ç¢¼ã€‚é¦–å…ˆï¼Œæ‰“é–‹ `pubspec.yaml`ï¼Œä¸¦æ·»åŠ ä»¥ä¸‹å…©è¡Œï¼š

```yaml
dependencies:
  # Add this
  cloud_firestore: ^0.14.1
  # Add this
  firebase_core: ^0.5.0
  flutter:
    sdk: flutter
  provider: ^4.3.2+2
```

èˆ‡å¾€å¸¸ä¸€æ¨£ï¼Œç•¶æ‚¨å° `pubspec.yaml` é€²è¡Œæ›´æ”¹æ™‚ï¼ˆé™¤éæ‚¨çš„ IDE æ›¿æ‚¨å®Œæˆæ­¤æ“ä½œï¼‰ï¼Œè«‹é‹è¡Œä»¥ä¸‹å‘½ä»¤ä¾†ä¸‹è¼‰å’Œé€£çµæ–°çš„å‡½å¼åº«ï¼š

```bash
$ flutter pub get
```

<blockquote>æ³¨æ„ï¼šå¦‚æœæ‚¨å°šæœªå»ºç«‹è³‡æ–™åº«ï¼šè«‹è¨ªå• Firebase ä¸»æ§å°çš„å°ˆæ¡ˆï¼Œé»æ“Š **Cloud Firestore** æ¨™ç±¤ï¼Œç„¶å¾Œé»æ“Š **å»ºç«‹è³‡æ–™åº«** æŒ‰éˆ•ã€‚</blockquote>

### ç­‰å¾… Firebase

æˆåŠŸä½¿ç”¨ Cloud Firestore çš„ç¬¬ä¸€æ­¥æ˜¯åˆå§‹åŒ– Firebaseï¼Œæœ€é—œéµçš„æ˜¯ *åœ¨ä»»å‹™æˆåŠŸä¹‹å‰ä¸è¦å˜—è©¦ä½¿ç”¨ä»»ä½• Firebase è³‡æº*ã€‚å¹¸é‹çš„æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€å€‹ StatefulWidget ä¾†åŒ…å«è©²é‚è¼¯ï¼Œè€Œä¸æ˜¯å°‡è©²ä»»å‹™æ•£ä½ˆåœ¨æ•´å€‹ç¨‹å¼ç¢¼ä¸­ã€‚

åœ¨ `firebasecounter/lib/firebase_waiter.dart` ä¸­å»ºç«‹ä¸€å€‹æ–°æª”æ¡ˆï¼Œä¸¦æ·»åŠ ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';

class FirebaseWaiter extends StatefulWidget {
  final Widget Function(BuildContext) builder;
  final Widget waitingChild;
  const FirebaseWaiter({
    @required this.builder,
    this.waitingChild,
    Key key,
  }) : super(key: key);

  @override
  _FirebaseWaiterState createState() => _FirebaseWaiterState();
}

class _FirebaseWaiterState extends State<FirebaseWaiter> {
  Future<FirebaseApp> firebaseReady;

  @override
  void initState() {
    super.initState();
    firebaseReady = Firebase.initializeApp();
  }

  @override
  Widget build(BuildContext context) => FutureBuilder<FirebaseApp>(
        future: firebaseReady,
        builder: (context, snapshot) => //<
            snapshot.connectionState == ConnectionState.done
                ? widget.builder(context)
                : widget.waitingChild,
      );
}
```

æ­¤é¡åˆ¥ä½¿ç”¨ Flutter ä¸­çš„æ¨¡å¼ï¼Œåˆ©ç”¨ç‰¹å®š Widget ä¾†å®Œå…¨è™•ç†æ‡‰ç”¨ç¨‹å¼ä¸­çš„ç‰¹å®šä¾è³´é …æˆ–å•é¡Œã€‚è¦ä½¿ç”¨æ­¤ `FirebaseWaiter` Widgetï¼Œè«‹è¿”å› `main.dart`ï¼Œä¸¦å° `MyApp` æ‡‰ç”¨ä»¥ä¸‹æ›´æ”¹ï¼š

```dart
// åœ¨é ‚éƒ¨æ·»åŠ æ­¤åŒ¯å…¥
import 'package:firebasecounter/firebase_waiter.dart';

// å°‡ `MyApp` æ›¿æ›ç‚ºæ­¤
class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Flutter Demo',
      theme: ThemeData(
        primarySwatch: Colors.blue,
        visualDensity: VisualDensity.adaptivePlatformDensity,
      ),
      home: FirebaseWaiter(
        builder: (context) => Consumer<ICounterManager>(
          builder: (context, manager, _child) => MyHomePage(
            manager: manager,
            title: 'Flutter Demo Home Page',
          ),
        ),
        // é€™æ˜¯æ”¾ç½®æ‚¨çš„å•Ÿå‹•é é¢çš„å¥½åœ°æ–¹ï¼
        waitingChild: Scaffold(
          body: const Center(child: CircularProgressIndicator()),
        ),
      ),
    );
  }
}
```

ç¾åœ¨ï¼Œæ‡‰ç”¨ç¨‹å¼å¯ä»¥ç­‰å¾… Firebase åˆå§‹åŒ–ï¼Œä½†å¯ä»¥åœ¨æ¸¬è©¦æœŸé–“é€éç°¡å–®åœ°ä¸ä½¿ç”¨ `FirebaseWaiter` ä¾†è·³éæ­¤éç¨‹ã€‚

<blockquote>æ³¨æ„ï¼šä¸Šè¿°æ›´æ”¹å¯èƒ½æœƒå°è‡´ Flutter æŠ±æ€¨ç¼ºå°‘ Firebase Pluginã€‚å¦‚æœå‡ºç¾é€™ç¨®æƒ…æ³ï¼Œè«‹å®Œå…¨é—œé–‰æ‡‰ç”¨ç¨‹å¼ä¸¦é‡æ–°é–‹å§‹é™¤éŒ¯ï¼Œé€™å°‡å…è¨± Flutter å®‰è£æ‰€æœ‰ç‰¹å®šæ–¼å¹³å°çš„ä¾è³´é …ã€‚</blockquote>

### å¾ Cloud Firestore ç²å–è³‡æ–™

é¦–å…ˆï¼Œé€éå°‡ä»¥ä¸‹è¡Œæ·»åŠ åˆ° `counter_manager.dart` çš„é ‚éƒ¨ä¾†åŒ¯å…¥ Cloud Firestoreï¼š

```dart
import 'package:cloud_firestore/cloud_firestore.dart';
```

æ¥ä¸‹ä¾†ï¼Œä¹Ÿåœ¨ `counter_manager.dart` ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹é¡åˆ¥ï¼š

```dart
class FirestoreCounterManager implements ICounterManager {
  AppState state;
  final FirebaseFirestore _firestore;

FirestoreCounterManager()
      : _firestore = FirebaseFirestore.instance,
        state = const AppState() {
    _watchCollection();
  }

void _watchCollection() {
    // Part 1
    _firestore
        .collection('clicks')
        .snapshots()
        // Part 2
        .listen((QuerySnapshot snapshot) {
      // Part 3
      if (snapshot.docs.isEmpty) return;
      // Part 4
      final _clicks = snapshot.docs
          .map<DateTime>((doc) {
            final timestamp = doc.data()['timestamp'];
            return (timestamp != null)
                ? (timestamp as Timestamp).toDate()
                : null;
          })
          // Part 5
          .where((val) => val != null)
          // Part 6
          .toList();
      // Part 7
      state = AppState(_clicks);
    });
  }

  @override
  void increment() {
    _firestore.collection('clicks').add({
      'timestamp': FieldValue.serverTimestamp(),
    });
  }
}
```

<blockquote>æ³¨æ„ï¼šæ­¤é¡åˆ¥å¹¾ä¹æ˜¯æ­£ç¢ºçš„ï¼Œä½†å®ƒæœƒå»ºç«‹ä¸€å€‹ç¨å¾Œæœƒæ¢è¨çš„éŒ¯èª¤ã€‚å¦‚æœæ‚¨ç¾åœ¨å°‡æ­¤ç¨‹å¼ç¢¼æ·»åŠ åˆ°æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­ä¸¦é‹è¡Œå®ƒï¼Œæ‚¨å°‡æœƒçœ‹åˆ°è¡Œç‚ºèˆ‡æ‚¨æƒ³è¦çš„ä¸åŒã€‚è«‹ç¹¼çºŒé–±è®€ï¼Œä»¥äº†è§£è©³ç´°çš„è§£é‡‹ï¼</blockquote>

é€™è£¡æœ‰å¾ˆå¤šäº‹æƒ…æ­£åœ¨ç™¼ç”Ÿï¼Œå› æ­¤è®“æˆ‘å€‘ä¸€æ­¥ä¸€æ­¥åœ°é€²è¡Œã€‚

é¦–å…ˆï¼Œ`FirestoreCounterManager` å¯¦ä½œäº† `ICounterManager` ä»‹é¢ï¼Œå› æ­¤å®ƒæ˜¯ç”Ÿç”¢ Widget ä¸­å¯ç”¨çš„å€™é¸è€…ã€‚ï¼ˆæœ€çµ‚ï¼Œå®ƒå°‡ç”± `DependenciesProvider` æä¾›ï¼ï¼‰`FirestoreCounterManager` ä¹Ÿç¶­è­·äº† `FirebaseFirestore` çš„å¯¦ä¾‹ï¼Œå®ƒèˆ‡ç”Ÿç”¢è³‡æ–™åº«çš„å¯¦æ™‚é€£æ¥ã€‚`FirestoreCounterManager` åœ¨åˆå§‹åŒ–æœŸé–“ä¹Ÿèª¿ç”¨ `_watchCollection()` ä¾†å»ºç«‹èˆ‡æ‚¨é—œå¿ƒçš„ç‰¹å®šè³‡æ–™çš„é€£æ¥ï¼Œé€™å°±æ˜¯äº‹æƒ…è®Šå¾—æœ‰è¶£çš„åœ°æ–¹ã€‚

`_watchCollection()` æ–¹æ³•åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œå€¼å¾—å–®ç¨ç ”ç©¶ã€‚

åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œ`_watchCollection()` èª¿ç”¨ `_firestore.collection('clicks').snapshots()`. é€™æœƒè¿”å›ä¸€å€‹æµï¼Œæ¯ç•¶é›†åˆä¸­çš„è³‡æ–™ç™¼ç”Ÿæ›´æ”¹æ™‚ï¼Œå°±æœƒæ›´æ–°ã€‚

åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œ`_watchCollection()` ç«‹å³ä½¿ç”¨ `.listen()` ç‚ºè©²æµè¨»å†Šä¸€å€‹ç›£è½å™¨ã€‚å‚³éçµ¦ `listen()` çš„å›èª¿åœ¨è³‡æ–™ç™¼ç”Ÿä»»ä½•æ›´æ”¹æ™‚æ¥æ”¶ä¸€å€‹æ–°çš„ `QuerySnapshot` ç‰©ä»¶ã€‚æ­¤æ›´æ–°ç‰©ä»¶ç¨±ç‚ºå¿«ç…§ï¼Œå› ç‚ºå®ƒåæ˜ äº†è³‡æ–™åº«åœ¨æŸä¸€æ™‚åˆ»çš„æ­£ç¢ºç‹€æ…‹ï¼Œä½†æ˜¯ï¼Œåœ¨ä»»ä½•æ™‚å€™éƒ½å¯èƒ½æœƒè¢«æ–°çš„å¿«ç…§æ›¿æ›ã€‚

åœ¨ç¬¬ä¸‰éƒ¨åˆ†ä¸­ï¼Œå›èª¿æœƒåœ¨é›†åˆç‚ºç©ºæ™‚çŸ­è·¯ã€‚

åœ¨ç¬¬å››éƒ¨åˆ†ä¸­ï¼Œå›èª¿æœƒéæ­·å¿«ç…§çš„æ–‡ä»¶ï¼Œä¸¦è¿”å›ä¸€å€‹åŒ…å«æ··åˆçš„ null å’Œ DateTime å€¼çš„åˆ—è¡¨ã€‚

åœ¨ç¬¬äº”éƒ¨åˆ†ä¸­ï¼Œå›èª¿æœƒæ¨æ£„ä»»ä½• null å€¼ã€‚é€™äº›æ˜¯å› å°‡è¦ä¿®å¾©çš„éŒ¯èª¤è€Œç”¢ç”Ÿçš„ï¼Œä½†æ˜¯é€™ç¨®é˜²ç¦¦æ€§ç¨‹å¼è¨­è¨ˆåœ¨è™•ç†ä¾†è‡ª Cloud Firestore çš„è³‡æ–™æ™‚ç¸½æ˜¯ä¸€å€‹å¥½ä¸»æ„ã€‚

åœ¨ç¬¬å…­éƒ¨åˆ†ä¸­ï¼Œå›èª¿æœƒè§£æ±º `map()` è¿”å›çš„æ˜¯è¿­ä»£å™¨è€Œä¸æ˜¯åˆ—è¡¨çš„äº‹å¯¦ã€‚å°è¿­ä»£å™¨èª¿ç”¨ `.toList()` æœƒå¼·åˆ¶å®ƒè™•ç†æ•´å€‹é›†åˆï¼Œé€™æ­£æ˜¯æ‚¨æƒ³è¦çš„ã€‚

æœ€å¾Œï¼Œåœ¨ç¬¬ä¸ƒéƒ¨åˆ†ä¸­ï¼Œå›èª¿æœƒæ›´æ–°ç‹€æ…‹ç‰©ä»¶ã€‚

è¦ä½¿ç”¨é€™å€‹æ–°çš„é¡åˆ¥ï¼Œè«‹æ‰“é–‹ `dependencies.dart`ï¼Œä¸¦å°‡å…¶å…§å®¹æ›¿æ›ç‚ºä»¥ä¸‹å…§å®¹ï¼š

```dart
import 'package:firebasecounter/counter_manager.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

class DependenciesProvider extends StatelessWidget {
  final Widget child;
  DependenciesProvider({@required this.child});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        // `Provider` å·²è¢« `ChangeNotifierProvider` æ›¿æ›
        ChangeNotifierProvider<ICounterManager>(
          create: (context) => FirestoreCounterManager(),
        ),
      ],
      child: child,
    );
  }
}
```

### è¨ºæ–·éŒ¯èª¤

å¦‚æœæ‚¨æŒ‰åŸæ¨£é‹è¡Œæ­¤ç¨‹å¼ç¢¼ï¼Œæ‚¨ *å¹¾ä¹* æœƒçœ‹åˆ°æ‰€éœ€çš„è¡Œç‚ºã€‚ä¸€åˆ‡éƒ½çœ‹èµ·ä¾†æ­£ç¢ºï¼Œé™¤äº†è¢å¹•å§‹çµ‚è½å¾Œæ–¼å¯¦éš›é»æ“Šæ¬¡æ•¸ä¸€æ¬¡ã€‚é€™æ˜¯æ€éº¼å›äº‹ï¼Ÿ

å•é¡Œå‡ºç¾åœ¨åˆå§‹è¨ˆæ•¸å™¨å¯¦ä½œå’Œç•¶å‰åŸºæ–¼æµçš„å¯¦ä½œä¹‹é–“çš„ä¸ç›¸å®¹æ€§ã€‚æµ®å‹•å‹•ä½œæŒ‰éˆ•çš„ `onPressed` è™•ç†å™¨çœ‹èµ·ä¾†åƒé€™æ¨£ï¼š

```dart
floatingActionButton: FloatingActionButton(
  onPressed: () => setState(() => widget.manager.increment()),
  ...
)
```

è©²è™•ç†å™¨èª¿ç”¨ `increment()` ä¸¦ç«‹å³èª¿ç”¨ `setState()`ï¼Œé€™æœƒå‘Šè¨´ Flutter é‡æ–°æ¸²æŸ“ã€‚

ç•¶åŒæ­¥æ›´æ–°å„²å­˜åœ¨è¨­å‚™è¨˜æ†¶é«”ä¸­çš„ç‹€æ…‹æ™‚ï¼Œé€™éå¸¸æœ‰æ•ˆã€‚ä½†æ˜¯ï¼Œæ–°çš„åŸºæ–¼æµçš„å¯¦ä½œæœƒå•Ÿå‹•ä¸€ç³»åˆ—ç•°æ­¥æ­¥é©Ÿã€‚é€™æ„å‘³è‘—ï¼ŒæŒ‰åŸæ¨£ï¼Œç¨‹å¼ç¢¼æœƒç«‹å³èª¿ç”¨ `setState()`ï¼Œç„¶å¾Œåƒ…åœ¨ä¸€å€‹æœªçŸ¥çš„æœªä¾†æ™‚é–“é»ï¼Œç®¡ç†å“¡ç‰©ä»¶æ‰æœƒæ›´æ–°å…¶ç‹€æ…‹å±¬æ€§ã€‚ç°¡è€Œè¨€ä¹‹ï¼Œ`onPressed` è™•ç†å™¨ä¸­çš„ `setState()` èª¿ç”¨éæ—©äº†ï¼æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå› ç‚ºæ‰€æœ‰é€™äº›æ´»å‹•éƒ½ç™¼ç”Ÿåœ¨å›èª¿å…§ï¼Œæ·±æ·±åœ°ä½æ–¼ `FirestoreCounterManager` ä¸­ï¼Œæ²’æœ‰ä»»ä½• Widget çŸ¥é“å®ƒï¼Œå› æ­¤æ²’æœ‰ä»»ä½• `Future` å¯ä»¥è®“ Widget ç­‰å¾…ä¾†è§£æ±ºå•é¡Œã€‚

é€™å°±åƒç®¡ç†å“¡ç‰©ä»¶éœ€è¦èƒ½å¤ å‘Šè¨´ Widget ä½•æ™‚é‡æ–°ç¹ªè£½ä¸€æ¨£ã€‚ ğŸ¤”

è¼¸å…¥ï¼š [ChangeNotifier](https://flutter.dev/docs/development/data-and-backend/state-mgmt/simple#changenotifier)

<blockquote>æ³¨æ„ï¼šå¦‚æœæ‚¨åœ¨æ­¤éƒ¨åˆ†é‡åˆ°å•é¡Œï¼Œè«‹å°‡æ‚¨çš„æ›´æ”¹èˆ‡å…¬é–‹å„²å­˜åº«ä¸­çš„ [é€™å€‹æäº¤](https://github.com/craiglabenz/flutter-firestore-counter/commit/3bf17b9bfac6c907b8650e1c668fa19b1160a51d) é€²è¡Œæ¯”è¼ƒã€‚é€™äº›æ›´æ”¹åŒ…æ‹¬æ·»åŠ  Firebase å¾Œç”¢ç”Ÿçš„ Xcode å’Œ build.gradle çš„æ›´æ”¹ï¼Œä½†æ˜¯æ‚¨å¯èƒ½å¯ä»¥å°ˆæ³¨æ–¼ Dart æª”æ¡ˆä¸­çš„æ›´æ”¹ã€‚
</blockquote>

### ä½¿ç”¨ ChangeNotifier é‡æ–°æ¸²æŸ“ Widget æ¨¹

`ChangeNotifier` æ˜¯ä¸€å€‹é¡åˆ¥ï¼Œå®ƒå®Œå…¨åƒå®ƒçš„åå­—æ‰€æš—ç¤ºçš„é‚£æ¨£åšï¼šç•¶ç™¼ç”Ÿéœ€è¦é‡æ–°æ¸²æŸ“çš„æ›´æ”¹æ™‚ï¼Œå®ƒæœƒé€šçŸ¥ Widgetã€‚

æ­¤éç¨‹çš„ç¬¬ä¸€æ­¥æ˜¯æ›´æ–° `ICounterManager` ä»‹é¢ä»¥æ“´å±• `ChangeNotifier`ã€‚è¦åŸ·è¡Œæ­¤æ“ä½œï¼Œè«‹æ‰“é–‹ `firebasecounter/lib/counter_manager.dart`ï¼Œä¸¦å° `ICounterManager` å®£å‘Šé€²è¡Œä»¥ä¸‹æ›´æ”¹ï¼š

```dart
// å°‡ `extends ChangeNotifier` æ·»åŠ åˆ°æ‚¨çš„å®£å‘Šä¸­
abstract class ICounterManager extends ChangeNotifier {
  // é¡åˆ¥ä¸­çš„æ‰€æœ‰å…§å®¹éƒ½ç›¸åŒã€‚
}
```

å¦‚æœæ‚¨å°šæœªåŒ¯å…¥ `flutter/material.dart`ï¼Œè«‹æ‰“é–‹ `firebasecounter/lib/counter_manager.dart`ï¼Œä¸¦å°‡å…¶æ·»åŠ åˆ°åº•éƒ¨ï¼š

```dart
import 'package:flutter/material.dart';
```

æ‚¨ç¾åœ¨å·²æº–å‚™å¥½æ›´æ–° `CounterManager` å’Œ `FirestoreCounterManager` çš„å®šç¾©ã€‚å°æ–¼ `CounterManager`ï¼Œè«‹å°‡å…¶ç¨‹å¼ç¢¼æ›¿æ›ç‚ºä»¥ä¸‹å¯¦ä½œï¼š

```dart
class CounterManager extends ChangeNotifier implements ICounterManager {
  AppState state = AppState();

  /// ä½¿ç”¨æœ€è¿‘ä¸€æ¬¡é»æ“Šçš„æ™‚é–“æˆ³è¤‡è£½ç‹€æ…‹ç‰©ä»¶ï¼Œ
  /// ä¸¦å‘Šè¨´æµæ›´æ–°ã€‚
  void increment() {
    state = state.copyWith(DateTime.now());
    // æ·»åŠ é€™è¡Œæ˜¯ `ChangeNotifier` å‘Šè¨´ Widget
    // é‡æ–°æ¸²æŸ“è‡ªèº«çš„æ–¹å¼ã€‚
    notifyListeners();
  }
}
```

å°æ–¼ `FirestoreCounterManager`ï¼Œæ‡‰ç”¨ä»¥ä¸‹æ›´æ”¹ï¼š

1. ä¿®æ”¹å®ƒçš„ç°½ç« ä»¥åŒ¹é…ä»¥ä¸‹å…§å®¹ï¼š

```dart
class FirestoreCounterManager extends ChangeNotifier
    implements ICounterManager {
    ...
}
```

2. å°‡ç›¸åŒçš„ `notifyListeners();` è¡Œæ·»åŠ åˆ° `_watchCollection()` çš„æœ«å°¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```dart
void _watchCollection() {
  _firestore
      .collection('clicks')
      .snapshots()
      .listen((QuerySnapshot snapshot) {

    // ç‚ºäº†æ¸…æ™°èµ·è¦‹ï¼Œçœç•¥äº† `_clicks` çš„ç”Ÿæˆï¼Œä½†ä¸è¦
    // æ›´æ”¹è©²ç¨‹å¼ç¢¼ã€‚

    state = AppState(_clicks);

    // å”¯ä¸€å¿…è¦çš„æ›´æ”¹æ˜¯æ·»åŠ é€™è¡Œï¼
    notifyListeners();
  });
}
```

æ‚¨ç¾åœ¨å·²ç¶“å»ºç«‹äº†è®“ `ICounterManager` é¡åˆ¥å‘Šè¨´ Widget ä½•æ™‚é‡æ–°æ¸²æŸ“çš„å¿…è¦æ›´æ”¹çš„ä¸€åŠã€‚ç®¡ç†å“¡é¡åˆ¥æ­£åœ¨å‘Šè¨´ Widget é‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯å¦‚æœæ‚¨ç¾åœ¨é‹è¡Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ï¼Œæ‚¨å°‡æœƒçœ‹åˆ° Widget æ²’æœ‰åœ¨ç›£è½ã€‚

è¦ä¿®å¾©æ­¤å•é¡Œï¼Œè«‹æ‰“é–‹ `dependencies.dart`ï¼Œä¸¦å°‡ `DependenciesProvider` çš„å¯¦ä½œæ›¿æ›ç‚ºä»¥ä¸‹å…§å®¹ï¼š

```dart
class DependenciesProvider extends StatelessWidget {
  final Widget child;
  DependenciesProvider({@required this.child});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        // `Provider` å·²è¢« `ChangeNotifierProvider` æ›¿æ›
        ChangeNotifierProvider<ICounterManager>(
          create: (context) => FirestoreCounterManager(),
        ),
      ],
      child: child,
    );
  }
}
```

ä½œç‚ºæœ€å¾Œçš„æ›´æ”¹ï¼Œè«‹å¾ `_MyHomePageState` ä¸­ç§»é™¤ `setState()`ï¼Œä»¥è·³éä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ã€‚å°‡å…¶ `FloatingActionButton` æ›´æ–°ç‚ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```dart
      floatingActionButton: FloatingActionButton(
        // ç§»é™¤ `setState()`ï¼
        onPressed: widget.manager.increment,
        tooltip: 'Increment',
        child: Icon(Icons.add),
      ),
```

å°±é€™æ¨£ï¼`ChangeNotifierProvider` ç¢ºä¿ Widget æ˜¯ã€Œç›£è½å™¨ã€ï¼Œå› æ­¤ç•¶ `ICounterManager` é¡åˆ¥èª¿ç”¨ `notifyListeners()` æ™‚ï¼ŒWidget æœƒæ”¶åˆ°é‡æ–°æ¸²æŸ“çš„è¨Šæ¯ã€‚

åœ¨é€™å€‹éšæ®µï¼Œæ‚¨æ‡‰è©²èƒ½å¤ ç†±é‡æ–°å•Ÿå‹•æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ï¼Œä¸¦çœ‹åˆ°æ‰€æœ‰å…§å®¹éƒ½æ­£å¸¸å·¥ä½œï¼

æ³¨æ„ï¼šå¦‚æœæ‚¨åœ¨æ­¤éƒ¨åˆ†é‡åˆ°å•é¡Œï¼Œè«‹å°‡æ‚¨çš„æ›´æ”¹èˆ‡å…¬é–‹å„²å­˜åº«ä¸­çš„ [é€™å€‹æäº¤](https://github.com/craiglabenz/flutter-firestore-counter/commit/dfb584f62d094d8fdb6067ea11ff3551b9186aed) é€²è¡Œæ¯”è¼ƒã€‚

### ä¿®å¾©æ¸¬è©¦