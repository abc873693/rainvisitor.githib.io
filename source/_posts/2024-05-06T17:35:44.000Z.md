---
title: 【文章翻譯】Best practices for optimizing Flutter web loading speed
tags:
  - Flutter
abbrlink: cbc08ce3
date: 2024-05-06 17:35:44
---

【文章內容使用 Gemini 1.5 Pro 自動產生】

## 優化 Flutter 網頁載入速度的最佳實務

作為一個與 Google Flutter 團隊合作，以及在私人時間裡也使用 Flutter 的開發者，我理解到 Flutter 網頁應用程式載入速度方面的疑慮。優化載入速度對於提升效能和提供良好的使用者體驗至關重要，特別是當 Flutter 開發者擴展到 Web 開發時。本指南提供可行的策略和最佳實務，以加速 Flutter 網頁應用程式的效能。

### 渲染

CanvasKit 是 Flutter 網頁應用程式的預設 [渲染器](https://docs.flutter.dev/platform-integration/web/renderers)，透過利用 WebGL 來提供高效能和跨平台的像素完美一致性。對於需要豐富動畫和高保真度的複雜圖形應用程式來說，此功能特別有用。但是，CanvasKit 本身的檔案大小（約 1.5 MB）可能是一個缺點，特別是對於初始載入時間至關重要的應用程式。

雖然 `flutter.js` 載入 API 並行下載 CanvasKit 和 `main.dart.js`，但所有 Flutter Widget 都必須等待它們完全載入到瀏覽器中，這可能會導致在應用程式變為互動式之前出現明顯的延遲。為了減輕這些疑慮並優化載入體驗，開發人員可以選擇 Wasm 渲染模式。

由於 Flutter 網頁中的 [WebAssembly 支援](https://docs.flutter.dev/platform-integration/web/wasm) 被認為是實驗性的，並且可能會發生變化，因此這些步驟適用於願意實驗尖端功能的開發人員。功能和命令可能會發生變化，因此始終參考最新的 Flutter 文件以獲取當前做法。

#### 相容性

使用 Wasm 建置時，`dart:html` 套件不受支援。此限制意味著您必須仔細考慮應用程式依賴的 API。或者，[web 套件] (https://pub.dev/packages/web) 被 `dart2wasm` 和 `dart2js` 支援。

#### 效能

Wasm 不僅減少了與 CanvasKit 相比的應用程式大小，而且與 JavaScript 相比，啟動速度也更快。

### 惰性載入

Dart 的 [延遲匯入](https://dart.dev/language/libraries#lazily-loading-a-library) 允許您分割程式碼，並且只在需要時載入部分程式碼，從而減少初始載入時間。以下幾節將討論如何使用延遲載入。

#### 宣告延遲匯入

在 Dart 檔案的頂部，宣告您要延遲的匯入。在匯入語句中，指定 `deferred`，後跟一個識別符號。當您需要使用函式庫時，請使用延遲匯入上的 `loadLibrary()` 方法異步載入它：

```
import 'package:myapp/hello.dart' deferred as hello;

Future<void> loadHelloLibrary() async {
  await hello.loadLibrary();
  hello.sayHi();
}
```

#### 呼叫載入函式

在 Flutter 應用程式中，根據需要呼叫此函式，例如，作為對使用者互動的回應。以下範例在使用者按下 Widget 時載入所需的函式庫：

```
import 'package:flutter/material.dart';

void main() {
  runApp(MaterialApp(home: MyApp()));
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            loadHelloLibrary();
          },
          child: Text('Load Feature'),
        ),
      ),
    );
  }
}
```

### 未等待的函式呼叫

為了減少顯示應用程式初始 Widget 所花費的時間，請嘗試在呼叫 `runApp` 之前不要等待昂貴的未來。有些未來可以不等待，以便它們在完成後更新 UI。`unawaited` 函式允許應用程式程式設計師明確地告知「未等待的未來」警告，這些未來預計不會被等待。此改進透過使應用程式感覺更具回應性，增強了應用程式啟動和頁面載入過程中的使用者體驗。但是，務必仔細管理此類函式，以避免與應用程式狀態一致性和資源管理相關的問題。

```
import 'dart:async';
import 'package:flutter/material.dart';

void main() {
  unawaited(downloadVideos().then((videos) {
    playlist.add(videos);
  }));

  runApp(const MyApp());
}
```

### 媒體檔案

#### 以最佳解析度顯示資產

Flutter 會自動根據設備的像素密度 [載入適當解析度的資產](https://docs.flutter.dev/ui/assets/assets-and-images#resolution-aware)。這可以確保在不同螢幕尺寸上都能獲得最佳視覺效果。雖然優化資產以實現高效傳遞非常重要，但在探索替代圖片格式之前，請優先考慮提供所需準確解析度的資產，就像我們在下一節中將要討論的那樣。

#### 更好的圖片壓縮

PNG 和 JPG 是網站上使用最廣泛的圖片格式之一。這些格式以其廣泛的支援和相容性而聞名。但是，新一代格式，例如 [WebP](https://developers.google.com/speed/webp) 和 [AVIF](https://netflixtechblog.com/avif-for-next-generation-image-coding-b1d75675fe4)，在減少檔案大小方面提供了顯著的進展，而不會顯著損害圖片品質。例如，原始大小為 319 KB 的 PNG 圖片可以在 WebP 格式中壓縮到僅 38 KB，或者更令人印象深刻的是，在 AVIF 格式中壓縮到 10 KB。這些檔案大小的減少是在人類視覺可察覺的品質損失最小的情況下實現的，這證明了這些格式在維持視覺保真度的同時，可以提高網站載入速度的潛力。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*_bz3_DRzn9aoB0qD" />
<figcaption>PNG 319 KB / WebP 38 KB / AVIF 10 KB</figcaption>
</figure>

但是，請注意，並非所有瀏覽器都支援 [WebP](https://caniuse.com/webp) 和 [AVIF](https://caniuse.com/avif) 圖片。在將這些格式整合到網站中之前，請驗證它們與您的受眾最常使用的瀏覽器是否相容。這將有助於您確定這些新一代圖片格式是否符合網站的要求和受眾需求。

### 快取

#### 記憶體、磁盤、Service Workers 快取

利用記憶體快取、磁盤快取和 Service Workers 的功能可以顯著減少初始頁面載入後的載入時間。這是因為這些快取機制需要檔案先載入一次才能快取它們。記憶體快取儲存在 RAM 中，提供快速存取速度，但易失性。另一方面，磁盤快取雖然速度較慢，但提供持久性。Service Workers 作為可程式設計的網路代理，可以在記憶體和磁盤中啟用複雜的快取策略。

瀏覽器或作業系統通常會自動管理記憶體和磁盤快取，除非有特定要求需要以程式設計方式操縱它們，否則您不需要手動干預。雖然 Flutter 在一定程度上管理 Service Workers，但開發人員可以靈活地在 Flutter 之外實作自訂 Service Workers，以增強對快取和網路互動的控制。

#### Wasm

瀏覽器快取 Wasm 檔案（如 CanvasKit，以及很快將推出的 `dart2wasm` 輸出），以及它們的編譯原生程式碼。這意味著快取的 Wasm 模組載入速度與原生二進位檔案一樣快，這與 JavaScript 不同，JavaScript 需要重新解析、重新編譯和重新 JIT（即時）處理。

雖然 Flutter 的 Wasm 建置選項尚未完全穩定，但採用現代 JS-interop 做法將在 `dart2wasm` 穩定時對您有所幫助。例如，避免使用 `dart:html` 和 `dart:js` 等傳統函式庫，並且優先考慮 `package:web` 和 `dart:js_interop`。此外，請考慮檢查您使用的其他套件是否與 Wasm 相容。

### 預載入

#### HTML &lt;head tag&gt;、HTTP 回應標頭

[預載入資產](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel/preload)，例如圖片、字體和 JavaScript 檔案，可以顯著提高網頁載入速度。透過在 HTML &lt;head&gt; 標籤中預載入或使用 HTTP 回應標頭，您可以指示瀏覽器在需要渲染時之前下載這些資源。這可以消除延遲，並確保更流暢的使用者體驗。若要預載入資產，請在 &lt;head&gt; 部分中新增 &lt;link&gt; 標籤，並將 `rel` 屬性設定為 `preload`。僅預載入立即使用的資產，理想情況下是在應用程式的第一個畫面中，否則瀏覽器會將預載入視為浪費頻寬。

#### HTML &lt;head&gt; 標籤

```html
<head>
  <link rel="preload" href="assets/logo.webp" as="image" type="image/webp" />
</head>
<body>
  <picture>
    <source src="assets/logo.webp" type="image/webp" />
  </picture>
</body>
```

#### Firebase 主機的 HTTP 回應標頭

以下程式碼塊是一個 `firebase.json` 範例，其中包含一個鍵/值組合，展示如何為資產預載入新增 HTTP 標頭。

```json
"headers": [
  {
    "key": "Link",
    "value": "<assets/logo.webp>; rel=preload; as=image"
  }
]
```

#### 首頁

Flutter 使您能夠使用純粹的 HTML/CSS 為您的應用程式建立完全互動式的首頁。當使用者與您的首頁互動時，`flutter.js` 會預載入您的 Flutter 應用程式，確保在使用者導航到 Flutter 應用程式時可以立即啟動。這對具有播放按鈕的遊戲和需要登入的應用程式特別有用。

### 載入/啟動畫面

雖然我們一直專注於應用程式載入速度的技術優化，但感知載入速度更為關鍵。您的目標應該是使應用程式 *感覺* 很快。

載入/啟動畫面在增強這種感知方面非常有效。透過提供視覺活动，它們可以讓使用者確信應用程式正在快速啟動。相反，空白畫面會帶來不確定性，可能會導致沮喪和頁面重新整理。

為了獲得最快的回應速度，請使用純粹的 CSS/HTML 在您的 `index.html` 檔案中直接實作您的啟動畫面。這可以最大限度地減少任何潛在的延遲。

例如，請查看 [Flutter Gallery 實作](https://github.com/flutter/gallery/blob/cfcb9dbda56697fe8bafe4b64c1a9261dde908ae/web/index.html#L211)。


### 結語

在本指南中，我們探討了加速 Flutter 網頁應用程式初始載入和渲染效能的方法。您可以採用各種策略，但請記住，每個解決方案都涉及權衡取捨。選擇最適合您的特定需求和使用者需求的優化方法。透過結合這些方法，您可以為您的 Flutter 網頁應用程式創造更流暢、更具回應性的使用者體驗。

<img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=7cc0df14ce5c" width="1" height="1" alt=""><hr><p><a href="https://medium.com/flutter/best-practices-for-optimizing-flutter-web-loading-speed-7cc0df14ce5c">優化 Flutter 網頁載入速度的最佳實務</a> 最初發佈在 <a href="https://medium.com/flutter">Flutter</a> 上的 Medium，人們在那裡透過突出顯示和回應這個故事來繼續討論。</p>
