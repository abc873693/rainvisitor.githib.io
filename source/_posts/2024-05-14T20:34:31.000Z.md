---
title: 【文章翻譯】What’s new in Flutter 3.22
tags:
  - Flutter
abbrlink: 9e5e250f
date: 2024-05-14 20:34:31
---

【文章內容使用 Gemini 1.5 Pro 自動產生】

## Flutter 3.22 的新功能：WebAssembly、圖形渲染增強功能，以及更多 AI 整合選項

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/1*hf9CEzGh0uhxnzVZi2Kk4g.png" />
</figure>

歡迎回來體驗另一個令人興奮的 Flutter 穩定版本！這次，我們很高興推出 Flutter 3.22。我們將 WebAssembly 帶到了 stable channel，為 Android 上的 Impeller 提供了一個功能齊全的 Vulkan 後端，它承諾提供更流暢的圖形和更大的效能提升。我們還通過新的 Widget 狀態屬性、動態視圖大小調整和改進的表格驗證引入了簡化的工作流程。但這還不是全部 - 您會發現風味條件資產捆綁、Dart 中的 Firebase Vertex AI 預覽以及更新的 DevTools，讓您的生活更輕鬆。

自我們上次更新以來，僅僅幾個月的時間，我們就從 Flutter 社群合併了令人印象深刻的 1595 個 pull request，其中 37 位新社群成員第一次為 Flutter 做出了貢獻！

因此，深入了解 Flutter 社群帶給這個最新版本的最新功能和增強功能吧！

### WebAssembly

隨著 Flutter 3.22 的發佈，Wasm 現在可在 stable channel 上使用，提供了顯著的效能提升。在我們使用 M1 MacBook 上的 Chrome 進行的內部基準測試中，Wonderous 應用程式的畫面渲染時間平均提高了 2 倍，在最壞情況下提高了 3 倍。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/719/0*x6HEkml8cFGc96hg" />
</figure>

這些增強功能對於具有動畫和豐富轉場的應用程式至關重要，在這些應用程式中，保持流暢的畫面率至關重要。Wasm 通過減少效能瓶頸來幫助實現這一點，從而實現更流暢的動畫和轉場。若要開始使用 Flutter Web 應用程式中的 Wasm，請查看我們的 [Dart Wasm 文件](https://dart.dev/web/wasm) 和 [Flutter Wasm 文件](https://docs.flutter.dev/platform-integration/web/wasm)。如需完整公告，請訪問 [Flutter 在 Google I/O 部落格文章](https://medium.com/flutter/io24-5e211f708a37)。

### 引擎

Flutter 3.22 對 Impeller 進行了重大更新，Impeller 是為您的 Flutter 應用程式提供渲染功能的渲染引擎。主要亮點包括為 Android 完成 Vulkan 後端，以實現更流暢的圖形和改進的效能，對模糊效果和複雜路徑渲染進行持續優化，以及一個用於測試 Impeller 的全新實驗性 API。根據我們的 [路線圖](https://github.com/flutter/flutter/wiki/Roadmap#core-framework--engine)，我們致力於提高 Impeller 的品質和效能，包括完成 iOS 對 Impeller 的遷移和擴展 Android 支援。

#### Impeller

#### **Android 上的 Vulkan 後端功能完整**

在此版本中，Impeller 的 Android Vulkan 後端功能完整。特別是，在過去的幾個月裡，團隊一直在努力完成 [快速高級混合](https://github.com/flutter/engine/pull/50154) 的實作、使用 [FragmentProgram API](https://github.com/flutter/engine/pull/49543) 支援自定義片段著色器、[PlatformView](https://github.com/flutter/engine/pull/50730) 支援（儘管它需要一個 [小型 API 遷移](https://docs.flutter.dev/release/breaking-changes/android-surface-plugins)）、以及完全實作 [所有模糊樣式](https://github.com/flutter/flutter/issues/134178)。

#### Android 預覽

在 3.19 穩定版本中，在發佈了 Impeller 的 OpenGL 後端的改進之後，我們邀請使用者在有和沒有 Vulkan 支援的 Android 設備上嘗試 Impeller。在過去的幾個月裡，在評估了 OpenGL 後端的效能並估計了 Vulkan 後端的剩餘工作量之後，我們決定將精力集中在首先使 Vulkan 後端達到生產就緒狀態。

Impeller 解決了著色器編譯卡頓的問題。此外，在我們的基準測試中，它在平均、第 90 個百分位數和第 99 個百分位數的畫面時間方面優於傳統渲染器。因此，我們認為 Vulkan 後端在 Android 上的效能是可以接受的。在此版本（3.22）中，選擇使用 Impeller 的應用程式將在有可用情況下使用 Vulkan 後端。在未來的版本中，這將成為預設配置。當選擇使用 Impeller 的應用程式在不支持 Vulkan 的設備上運行時，Flutter 將自動優雅地回退到使用帶有 Skia 的 OpenGL ES。您不需要採取任何操作。在將來，當我們認為 OpenGL ES Impeller 後端已達到生產就緒狀態時，這種回退也將使用 Impeller。

隨著 Android 上的 Impeller 預覽繼續在 3.22 穩定版本週期中進行，我們請求 Flutter 開發人員升級到最新的穩定版本，並提交有關在 [啟用 Impeller](https://docs.flutter.dev/perf/impeller#android) 時發現的任何不足的錯誤。在此階段的回饋對確保 Impeller 在 Android 上取得成功以及我們能夠在今年晚些時候的版本中自信地將其設為預設渲染器至關重要。Android 硬體生態系統非常多元。因此，關於 Impeller 最有用的回饋應包括有關發生問題的特定設備和 Android 版本的詳細資訊。

#### 模糊效能提升

模糊已在 iOS 和 Android 上的 Impeller 中 [重新實作](https://github.com/flutter/engine/pull/47576)。特別是，這種新方法類似於 Skia 的方法，在 [基準測試](https://flutter-flutter-perf.skia.org/e/?begin=1699468487&amp;end=1710262311&amp;keys=X01fc3d52ebd6fbf38afef91d82ab8d2b&amp;requestType=0&amp;selected=commit%3D38815%26name%3D%252Carch%253Dintel%252Cbranch%253Dmaster%252Cconfig%253Ddefault%252Cdevice_type%253DiPhone_11%252Cdevice_version%253Dnone%252Chost_type%253Dmac%252Csub_result%253Daverage_frame_rasterizer_time_millis%252Ctest%253Dbackdrop_filter_perf_ios__timeline_summary%252C&amp;xbaroffset=38815) 中將模糊的 CPU 和 GPU 時間減少了將近一半。

下圖顯示了在 iPhone 11 設備上，在一個旨在突出顯示模糊效能的病態基準測試中，最壞情況下的第 99 個百分位數、第 90 個百分位數和平均畫面柵格化時間以及 GPU 畫面時間（以毫秒為單位）。在重寫了 Impeller 的模糊之後，背景濾鏡模糊的 CPU 和 GPU 成本都減少了將近一半。這種改進的規模也適用於非病態案例，如典型應用程式中出現的案例。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*mtFyiLoIUSqk_zRB" />
<figcaption>在 iPhone 11 設備上，在一個旨在突出顯示模糊效能的病態基準測試中，第 99 個百分位數、第 90 個百分位數和平均畫面柵格化時間以及 GPU 畫面時間（以毫秒為單位）</figcaption>
</figure>

#### 模板然後覆蓋

iOS 和 Android 上的 Impeller 已 [遷移到新的渲染策略](https://github.com/flutter/engine/pull/51219)，該策略基於 [OpenGL Redbook](http://www.opengl-redbook.com/) 中“使用模板緩衝區繪製填充的凹多邊形”一章中描述的模板然後覆蓋方法。團隊成員在 GitHub 議題 [＃123671](https://github.com/flutter/flutter/issues/123671) 中討論了此技術在適用於 Flutter 時的更多內容。

這種方法解決了柵格線程花費過多時間在 CPU 上計算複雜路徑（例如 SVG 和 [Lottie 動畫](https://github.com/flutter/flutter/issues/141961)）的鑲嵌的問題。在更改之後，包含複雜路徑的畫面的總畫面時間（CPU 上的 UI 線程 + CPU 上的柵格線程 + GPU 工作）要低得多。使用者會注意到 Lottie 動畫和其他複雜路徑的渲染更加流暢，CPU 利用率更低，GPU 利用率略高。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/1*1lCd7dBwJ0ab_sieDlQNFw.gif" />
<figcaption>(左) Lottie 動畫。以前，Impeller 在最新的 iPhone 上需要 64 毫秒/畫面的柵格線程 CPU 時間來渲染它。（右）在我們實施了模板然後覆蓋優化之後，在同一設備上渲染的相同動畫。柵格時間幾乎快了 10 倍。</figcaption>
</figure>

雖然對這些改进感到滿意，但仍有更多工作要做。除了其他機會以外，我們意識到多邊形生成仍然在 CPU 配置檔中很突出，我們打算調查將這項工作轉移到 GPU，同樣。

#### 新的 API

儘管仍處於實驗階段，但 flutter test 現在接受 `--enable-impeller` 標誌，它使用 Vulkan 後端來執行 Impeller。

### 架構

#### Widget 狀態屬性

MaterialState 已被移出 Material 函式庫並重新命名為 WidgetState，以便它可以被 Cupertino、基本 Flutter 框架和套件作者使用。如需有關遷移到新 WidgetState 的更多資訊，請查看 [遷移指南](https://docs.flutter.dev/release/breaking-changes/material-state)。

#### 動態視圖大小調整

對動態視圖大小調整的 [增強功能](https://github.com/flutter/flutter/pull/140918) 有利於構建響應式佈局的開發人員，確保 UI 在各種設備螢幕上具有更好的適應性。

#### 改進的表格驗證

感謝 Flutter 社群成員 [SharbelOkzan](https://github.com/SharbelOkzan) 的 [貢獻](https://github.com/flutter/flutter/pull/135578)，Flutter 3.22 帶來了更加靈活的表格驗證方法，允許開發人員建立更加健全的使用者輸入處理，從而提高可用性和安全性。

#### 2D API 中的協變

減少 2D 圖形 API 中需要類型轉換的次數，可以簡化開發工作流程並提高效能，這對於遊戲和複雜動畫至關重要。

#### 風味條件資產捆綁

使用 [風味](https://docs.flutter.dev/deployment/flavors) 功能的開發人員現在可以將個別資產配置為僅在為特定風味構建時捆綁。如需更多信息，請查看 [根據風味有條件地捆綁資產](https://docs.flutter.dev/deployment/flavors#conditionally-bundling-assets-based-on-flavor)。

#### 使用 Dart 套件轉換資產

使用者現在可以將 Dart 套件配置為在捆綁時轉換其應用程式的資產。如需更多信息，請查看 [在構建時轉換資產](http://docs.flutter.dev/ui/assets/asset-transformation)。

### Android

#### 深度鏈接

深度鏈接可以顯著改善 Flutter 應用程式中的使用者體驗，作為捷徑，可以無縫引導使用者到應用程式中的特定內容，提高參與度並推動銷售。雖然 iOS 的通用鏈接和 Android 的應用程序鏈接因其安全性和平易近人的特性而受到高度推薦，但設定它們可能會有點棘手。

在最近的 Flutter 穩定版本中，我們在 DevTools 中引入了一個深度鏈接驗證工具，該工具支援檢查 Android 應用程式的 Web 配置。在此版本中，我們加入了一組新功能，以幫助驗證 Android 清單檔案中的設定。

如需有關使用此工具的更多資訊，請查看 [驗證深度鏈接](https://docs.flutter.dev/tools/devtools/deep-links)。

#### 預測性後退手勢

Flutter 現在為 Android 的預測性後退功能提供更多支援，在這種功能中，使用者可以在後退手勢期間預覽上一個路徑，甚至預覽上一個應用程式。這仍然是 Android 設備上的功能標誌，但您可以在 [GitHub](https://github.com/flutter/flutter/issues/132504#issuecomment-2025776552) 上找到有關如何自己嘗試它的詳細信息。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/400/0*8b6DxQuMXAyYVu-w" />
</figure>

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/400/0*hr_OF9DsfUcsLNHv" />
</figure>

#### Flutter 工具在 Gradle、AGP、Java 和 Kotlin 上強制執行版本要求

在此版本中，Flutter 工具強制執行有關它支援的 Gradle、Android Gradle Plugin (AGP)、Java 和 Kotlin 版本的策略。最初，該工具只提供警告。

目前，支援的版本範圍如下：

* Gradle - 完全支援 7.0.2 到目前版本，否則警告
* AGP - 完全支援 7.0.0 到目前版本，否則警告
* Java - 完全支援 Java 11 到目前版本，否則警告
* Kotlin - 完全支援 1.5.0 到目前版本，否則警告

在下次主要發佈版本中，這些警告將變為錯誤，可以使用標誌 `--android-skip-build-dependency-validation` 覆蓋。更一般地說，該工具在完全放棄支援（生成錯誤）特定版本的這些相依項之前，至少會為一個版本提供警告。

這種策略在 [相關設計規格](https://docs.google.com/document/d/1qeeM5QG-jiafttSgvc7yvC19IDRggFFZQTktBVxL6sI/edit?resourcekey=0-HLEAiBOMxAlQxDs-mEeffw) 中進行了討論。評論和回饋始終歡迎。

#### 支援在 Android 上的 Gradle 建構腳本中使用 Gradle Kotlin DSL

Gradle Kotlin DSL 現在在 Flutter 中受支援，為傳統的 Gradle Groovy DSL 提供了替代方案。這種支援允許更好的程式碼編輯體驗，包括自動完成、快速存取文檔、來源導航和上下文感知重構。

此初始支援由 GitHub 用戶 [bartekpacia](https://github.com/bartekpacia) 貢獻。開發人員現在可以选择使用 Kotlin 重寫其 Gradle 建構腳本，以利用這些優點，儘管 Flutter 工具在使用 flutter create 時還沒有允許在使用 Kotlin 時選擇 Kotlin 而不是 Groovy。

如需更多詳情，請查看由 [bartekpacia](https://github.com/bartekpacia) 提交的 [PR 140744](https://github.com/flutter/flutter/pull/140744)。

#### 平台視圖改進

**注意所有 Flutter 應用程式開發人員！**如果您使用 Flutter 開發依賴原生 Android 組件（如地圖、Web 視圖或某些 UI 元素）的應用程式，我們有一些重要新聞。

由於 Android 14 中的一個錯誤，使用舊版本 Flutter 構建的應用程式可能無法在運行此新 Android 版本的設備上正常工作。

Flutter 3.22 修復了此問題，並改進了 Android 應用程式中這些原生組件的整體效能。因此，為了確保您的應用程式在所有 Android 設備上順暢運行，請務必使用 Flutter 3.22 重新構建和發佈您的應用程式。

此更新還包含幕後改進，使 Android 上的平台視圖更加可靠和高效。

#### 對 KitKat 的支援結束

Flutter 現在的最低支援 Android 版本為 Lollipop (API 21)。從 Flutter 的 3.22 穩定版本開始，Flutter 將不再在運行 Android KitKat (API 19) 的設備上工作。如需更多詳情，請查看我們的 [棄用指南](https://docs.flutter.dev/release/breaking-changes/android-kitkat-deprecation)。

### iOS

#### 平台視圖效能

我們了解 iOS 上的平台視圖效能一直是許多 Flutter 開發人員的痛點。這在使用平台視圖時在捲軸視圖中尤為明顯。

最近的更新直接解決了這些擔憂，在嵌入文章中的多個內聯廣告等場景中取得了顯著的改进。以下是我們 [基準測試](https://github.com/flutter/flutter/pull/144745) 中的一些主要改進：

* **減少 GPU 使用率：**GPU 使用率降低了 50%，導致功耗降低，使用者體驗可能更加流暢。
* **改進畫面渲染：**平均畫面渲染時間減少了 1.66 毫秒（33%）。
* **最小化卡頓：**最壞情況下的畫面渲染時間減少了 3.8 毫秒（21%）。

如果您之前在捲軸視圖中使用多個平台視圖（如廣告、地圖等）時遇到過效能挑戰，那麼這些優化將有可能提供更流暢、更響應的捲動體驗。請嘗試一下，並告訴我們您的想法。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*uk0URkHcImHdTq2M" />
</figure>

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*-KX8Ubw77KpdGnPI" />
</figure>

### 生態系統

#### Vertex AI for Firebase Dart SDK 預覽版本發佈

Vertex AI for Firebase 產品已發佈為公眾預覽版，並包含 Dart SDK。這使您能夠使用 Gemini API 為您的 Dart 或 Flutter 應用程式構建生成式 AI 功能，同時考慮生產、效能和企業規模。該 SDK 與 [Firebase App Check](https://firebase.google.com/docs/app-check) 整合，該檢查保護您的 API 調用，並保護您的後端基礎架構免受嚴重的威脅，例如計費欺詐、釣魚和應用程式冒充。跳轉到 [Dart 入門](https://firebase.google.com/docs/vertex-ai/get-started?platform=flutter)，並使用促銷碼免費開始使用它。

<figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*KmIhzrfoyskNW7r8" />
</figure>

[Google AI Dart SDK](https://ai.google.dev/gemini-api/docs/get-started/dart) 仍然可用，建議僅用於原型設計。Google AI 具有免費的存取權限（在限制和有提供的地方），並提供按使用量付費的定價。如果您一直在使用 Google AI Dart SDK 進行原型設計，並且準備遷移到 Vertex AI for Firebase，請查看 [遷移指南](https://firebase.google.com/docs/vertex-ai/migrate-to-vertex-ai?platform=flutter)。

#### DevTools 更新

我們將繼續改進 DevTools，這是 Dart 和 Flutter 的效能和除錯工具套件。此版本包含效能提升、一般潤色以及新功能，例如在時間軸中包含 CPU 樣本、高級過濾以及支援匯入和匯出記憶體快照。

其他值得注意的改进已在 devtools_extensions 和 devtools_app_shared 套件中發佈，這些套件支援 DevTools 擴展作者。我们添加了對將擴展連接到新的 Dart Tooling Daemon (DTD) 的支援，這允許 DevTools 擴展存取由其他 DTD 客戶端（例如 IDE）註冊的公用方法，以及存取用於與開發專案互动的最小檔案系統 API。

若要進一步了解 Flutter 3.22 中包含的所有更新，請查看 DevTools 的發行備註 [2.32.0](https://docs.flutter.dev/tools/devtools/release-notes/release-notes-2.32.0)，[2.33.0](https://docs.flutter.dev/tools/devtools/release-notes/release-notes-2.33.0) 和 [2.34.1](https://docs.flutter.dev/tools/devtools/release-notes/release-notes-2.34.1)。

#### Flutter 的 Google 行動廣告 SDK

對於那些使用廣告變現 Flutter 應用程式的人來說，我們有一些令人興奮的新聞：Flutter 的 Google 行動廣告剛剛發佈了 5.0.1 版本的重大更新！

**增強對使用者訊息平台 (UMP) SDK 的支援：**更新添加了對 Android UMP SDK 版本 2.2.0 和 iOS UMP SDK 版本 2.4.0 中的最新 API 的支援。UMP SDK 對於遵守隱私法規至關重要，使您更容易獲得使用者對個性化廣告的同意。此新版本引入了多個新 API 來簡化同意收集流程。

**擴展中介夥伴：**我們通過提供與受歡迎的廣告夥伴的整合，拓寬了您的廣告變現範圍，包括 [Unity](https://pub.dev/packages/gma_mediation_unity)、[Meta](https://pub.dev/packages/gma_mediation_meta)、[AppLovin](https://pub.dev/packages/gma_mediation_applovin)、[Iron Source](https://pub.dev/packages/gma_mediation_ironsource)、[Mintegral](https://pub.dev/packages/gma_mediation_mintegral)、[Pangle](https://pub.dev/packages/gma_mediation_pangle)、[DT Exchange](https://pub.dev/packages/gma_mediation_dtexchange)、[InMobi](https://pub.dev/packages/gma_mediation_inmobi) 和 [Liftoff](https://pub.dev/packages/gma_mediation_liftoffmonetize)。您現在可以使用擴展的中介選項和簡化的實作來最大限度地提高應用程式收入。

我們鼓勵您在 Flutter 應用程式中嘗試這些新功能，並告訴我們您希望我們支援哪些其他中介夥伴。您的回饋對於我們持續改進 Flutter 的 Google 行動廣告 SDK 至關重要。

### 重大變更和棄用

#### 移除第 1 版 Android 嵌入

第一版 Android 嵌入的刪除正在進行中。這對大多數應用程式可能沒有影響，因為

1. 第 2 版已經成為預設版本很多年了
2. Flutter 工具將阻止構建第 1 版應用程式，除非使用標誌 `--ignore-deprecation` 明確覆蓋。

此版本完全中斷了 Flutter 工具對第 1 版應用程式的支援。**不再可以覆蓋。**

**Plugin 作者請注意：**當最初棄用第 1 版 Android 嵌入時，為 Plugin 作者編寫了遷移文檔，網址為 [https://docs.flutter.dev/release/breaking-changes/plugin-api-migration](https://docs.flutter.dev/release/breaking-changes/plugin-api-migration)。作為此遷移的一部分，建議 Plugin 作者通過在他們的 *Plugin.java* 中包含一個具有以下簽名的方法來保持對使用第 1 版嵌入的應用程式的支援

```java
public static void registerWith(@NonNull io.flutter.plugin.common.PluginRegistry.Registrar registrar)
```

我們計劃在下一個版本中完全刪除第 1 版 Android 嵌入，**屆時包含具有此簽名的 Plugin 方法將無法編譯**（因為它引用了第 1 版 Android 嵌入的類型）。

它目前沒有任何作用，因為此版本中斷了使用第 1 版嵌入的應用程式。我們建議 Plugin 作者儘快發佈更新版本的 Plugin，其中刪除了第 1 版程式碼，以避免在 Flutter 的未來版本中出現故障。例如，請查看 [PR 6494](https://github.com/flutter/packages/pull/6494)，該 PR 刪除了 Flutter 團隊維護的 Plugin。

#### 在 3.22 中移除的棄用

此版本中的 [重大變更](https://docs.flutter.dev/release/breaking-changes) 包括在 v3.19 發佈之後過期的棄用 API。若要查看所有受影響的 API，以及其他上下文和遷移指南，請查看 [此版本中的棄用指南](https://docs.flutter.dev/release/breaking-changes/3-19-deprecations)。其中許多受到 [Flutter fix](https://docs.flutter.dev/development/tools/flutter-fix) 的支援，包括 IDE 中的快速修復。可以使用 dart fix 命令行工具評估和應用批量修復。

與往常一樣，非常感謝社群為 [貢獻測試](https://github.com/flutter/tests/blob/master/README.md) - 這些測試幫助我們識別出這些重大變更。若要進一步了解，請查看 [Flutter 的重大變更策略](https://github.com/flutter/flutter/wiki/Tree-hygiene#handling-breaking-changes)。

### 結語

Flutter 成功背後的核心是您 - 我們非凡的社群。沒有您無數的貢獻和堅定的熱情，這個版本是不可能實現的。我們衷心感謝您。

準備好探索 Flutter 3.22 嗎？深入查看完整的發行備註和更改日誌，啟動您的終端機，然後運行 flutter upgrade。我們迫不及待想看看您會建立什麼！

<img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=fbde6c164fe3" width="1" height="1" alt=""><hr><p><a href="https://medium.com/flutter/whats-new-in-flutter-3-22-fbde6c164fe3">Flutter 3.22 的新功能</a> 最初發佈在 <a href="https://medium.com/flutter">Flutter</a> 上的 Medium，人們在那裡透過突出顯示和回應這個故事來繼續討論。</p>