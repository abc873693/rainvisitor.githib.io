<!DOCTYPE html>
<html lang="zh-tw,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.rainvisitor.me","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="【文章內容使用 Gemini 1.5 Pro 自動產生】   為什麼選擇 Cloud Firestore？FlutterFire 技術堆疊，由 Flutter 和 Firebase（特別是 Cloud Firestore）組成，在您構建和發佈應用程式時，為您解鎖了前所未有的開發速度。在本文中，您將探索這兩種技術之間的強大整合，重點關注測試和使用乾淨的架構模式。但是，您將一步一步地構建自己的方法，而">
<meta property="og:type" content="article">
<meta property="og:title" content="【文章翻譯】Testable Flutter and Cloud Firestore">
<meta property="og:url" content="https://blog.rainvisitor.me/archives/f22b27a6.html">
<meta property="og:site_name" content="RainVisitor Blog">
<meta property="og:description" content="【文章內容使用 Gemini 1.5 Pro 自動產生】   為什麼選擇 Cloud Firestore？FlutterFire 技術堆疊，由 Flutter 和 Firebase（特別是 Cloud Firestore）組成，在您構建和發佈應用程式時，為您解鎖了前所未有的開發速度。在本文中，您將探索這兩種技術之間的強大整合，重點關注測試和使用乾淨的架構模式。但是，您將一步一步地構建自己的方法，而">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://cdn-images-1.medium.com/max/1024/1*pQJzBr81G169df-ffo24Cg.png">
<meta property="article:published_time" content="2020-10-15T11:34:38.000Z">
<meta property="article:modified_time" content="2024-09-30T08:55:14.897Z">
<meta property="article:author" content="Rainvisitor">
<meta property="article:tag" content="flutter">
<meta property="article:tag" content="testing">
<meta property="article:tag" content="dependency-injection">
<meta property="article:tag" content="firebase">
<meta property="article:tag" content="cloud-firestore">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn-images-1.medium.com/max/1024/1*pQJzBr81G169df-ffo24Cg.png">

<link rel="canonical" href="https://blog.rainvisitor.me/archives/f22b27a6.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-tw'
  };
</script>

  <title>【文章翻譯】Testable Flutter and Cloud Firestore | RainVisitor Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">RainVisitor Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">RainVisitor</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://blog.rainvisitor.me/archives/f22b27a6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rainvisitor">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RainVisitor Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【文章翻譯】Testable Flutter and Cloud Firestore
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-15 19:34:38" itemprop="dateCreated datePublished" datetime="2020-10-15T19:34:38+08:00">2020-10-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-30 16:55:14" itemprop="dateModified" datetime="2024-09-30T16:55:14+08:00">2024-09-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Flutter/" itemprop="url" rel="index"><span itemprop="name">Flutter</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>【文章內容使用 Gemini 1.5 Pro 自動產生】</p>
<figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*pQJzBr81G169df-ffo24Cg.png" /></figure>

<h3 id="為什麼選擇-Cloud-Firestore？"><a href="#為什麼選擇-Cloud-Firestore？" class="headerlink" title="為什麼選擇 Cloud Firestore？"></a>為什麼選擇 Cloud Firestore？</h3><p><a href="https://firebase.flutter.dev/">FlutterFire</a> 技術堆疊，由 Flutter 和 Firebase（特別是 Cloud Firestore）組成，在您構建和發佈應用程式時，為您解鎖了前所未有的開發速度。在本文中，您將探索這兩種技術之間的強大整合，重點關注測試和使用乾淨的架構模式。但是，您將一步一步地構建自己的方法，而不是直接跳到最終實作，這樣每個步驟背後的理由就清晰明瞭。</p>
<h3 id="您將構建什麼？"><a href="#您將構建什麼？" class="headerlink" title="您將構建什麼？"></a>您將構建什麼？</h3><p>為了展示將 Cloud Firestore 作為您應用程式後端的乾淨方法，您將構建經典 Flutter 計數器應用程式的修改版本。唯一的區別是，每次點擊的時間戳都儲存在 Cloud Firestore 中，並且顯示的計數是從儲存的時間戳的數量中推導出來的。您將使用 Provider 和 ChangeNotifier 保持依賴項和狀態管理程式碼乾淨，並且您將更新生成的測試以保持程式碼的 <em>正確性</em>！</p>
<h3 id="開始之前"><a href="#開始之前" class="headerlink" title="開始之前"></a>開始之前</h3><p>本文假設您已 <a href="https://www.youtube.com/watch?v=Mx24wiPilHg">觀看並按照此教學中的步驟操作</a> 將您的應用程式與 Firebase 整合。簡要說明一下：</p>
<ol>
<li>建立一個新的 Flutter 專案，並命名為 firebasecounter。</li>
<li>在 <a href="https://console.firebase.google.com/">Firebase 主控台</a> 中建立一個 Firebase 應用程式。</li>
<li>將您的應用程式連結到 iOS 和&#x2F;或 Android，具體取決於您的開發環境和目標受眾。</li>
</ol>
<blockquote>注意：如果您將您的應用程式設定為在 Android 客戶端上運行，請務必 [建立一個 `debug.keystore` 檔案](https://gist.github.com/henriquemenezes/70feb8fff20a19a65346e48786bedb8f)，然後再生成您的 SHA1 憑證。</blockquote>

<p>在您在 Firebase 中生成 iOS 或 Android 應用程式之後，您就可以繼續進行。影片的其餘部分包含您在實際專案中可能需要的精彩內容，但對於本教學來說不是必需的。</p>
<h3 id="如果您遇到問題"><a href="#如果您遇到問題" class="headerlink" title="如果您遇到問題"></a>如果您遇到問題</h3><p>如果本教學中的任何步驟對您不起作用，請諮詢 <a href="https://github.com/craiglabenz/flutter-firestore-counter">這個公開的儲存庫</a>，它將更改分解為不同的提交。在整個教學中，您將在適當的位置找到指向每個提交的連結。請隨時使用它來驗證您是否已按照預期的方式進行！</p>
<h3 id="建立一個簡單的狀態管理員"><a href="#建立一個簡單的狀態管理員" class="headerlink" title="建立一個簡單的狀態管理員"></a>建立一個簡單的狀態管理員</h3><p>要開始將您的應用程式與 Cloud Firestore 整合的過程，您必須首先重構生成的程式碼，以便初始 StatefulWidget 與單獨的類別進行通訊，而不是與自身的屬性進行通訊。這讓您最終可以指示該單獨的類別使用 Cloud Firestore。</p>
<p>在您的專案的自動生成的 <code>main.dart</code> 檔案旁邊，建立一個名為 <code>counter_manager.dart</code> 的新檔案，並將以下程式碼複製到其中：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="language-markdown">建立一個私有整數來儲存計數。將其設為私有，</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">因此 Widget 無法直接修改它，而是必須</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">使用官方方法。</span></span></span><br><span class="line">  <span class="built_in">int</span> _count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">公開可存取的狀態參考。</span></span></span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">get</span> count =&gt; _count;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">公開可存取的狀態修改器。</span></span></span><br><span class="line">  <span class="keyword">void</span> increment() =&gt; _count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在程式碼就位後，將以下行新增到 <code>firebasecounter/lib/main.dart</code> 的頂部：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/counter_manager.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>然後，將 <code>_MyHomePageState</code> 的程式碼更改為以下內容：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> manager = CounterManager();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _incrementCounter() &#123;</span><br><span class="line">    setState(() =&gt; manager.increment());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Text(<span class="string">&#x27;You have pushed the button this many times:&#x27;</span>),</span><br><span class="line">            Text(</span><br><span class="line">              <span class="string">&#x27;<span class="subst">$&#123;manager.count&#125;</span>&#x27;</span>,</span><br><span class="line">              style: Theme.of(context).textTheme.headline4,</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: _incrementCounter,</span><br><span class="line">        tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>儲存此程式碼更改後，您的應用程式可能會顯示崩潰並顯示一個紅色的錯誤螢幕。這是因為您引入了一個新的變數 <code>manager</code>，它初始化的機會已經過了。當您更改狀態的 <em>初始化方式</em> 時，這在 Flutter 中很常見，並且可以使用熱重新啟動輕鬆解決。</p>
<p>熱重新啟動後，您應該回到開始的地方：計數為 0，並且可以根據需要點擊浮動動作按鈕。</p>
<p>現在是運行 Flutter 在任何新的專案中提供的單一測試的好時機。您可以在 <code>test/widget_test.dart</code> 中找到它的定義，並透過運行以下命令執行它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flutter <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>假設測試通過，您就可以繼續進行！</p>
<blockquote>注意：如果您在此部分遇到問題，請將您的更改與教學儲存庫中的 [這個提交](https://github.com/craiglabenz/flutter-firestore-counter/commit/483dd3b3833bf710b04db4a3ba347b1d1ecbe5de) 進行比較。</blockquote>

<h3 id="持續時間戳"><a href="#持續時間戳" class="headerlink" title="持續時間戳"></a>持續時間戳</h3><p>初始應用程式描述中提到了持續儲存每次點擊的時間戳。到目前為止，您尚未添加任何基礎架構來滿足第二個要求，因此請建立另一個名為 <code>app_state.dart</code> 的新檔案，並添加以下類別：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// <span class="language-markdown">應用程式狀態的完整容器。</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">此類別的實例應該能夠告知任何時候</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">渲染的內容。</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppState</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="language-markdown">完整的點擊歷史記錄。用於非常重要的審計目的。</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">點擊的計數變為此列表的 <span class="code">`length`</span> 屬性。</span></span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">DateTime</span>&gt; clicks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">預設生成式建構函式。對常數友好，以實現最佳</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">效能。</span></span></span><br><span class="line">  <span class="keyword">const</span> AppState([<span class="built_in">List</span>&lt;<span class="built_in">DateTime</span>&gt; clicks])</span><br><span class="line">      : clicks = clicks ?? <span class="keyword">const</span> &lt;<span class="built_in">DateTime</span>&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">方便的輔助函式。</span></span></span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">get</span> count =&gt; clicks.length;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">複製方法，它返回一個新的 AppState 實例，而不是</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">修改現有的副本。</span></span></span><br><span class="line">  AppState copyWith(<span class="built_in">DateTime</span> latestClick) =&gt; AppState([</span><br><span class="line">        latestClick,</span><br><span class="line">        ...clicks,</span><br><span class="line">      ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從現在開始，<code>AppState</code> 類別的工作是表示應該渲染的內容的狀態。該類別不包含任何可以修改自身的方法，只有一個單獨的 <code>copyWith</code> 方法，其他類別將使用它。</p>
<p>牢記測試，您可以開始更改 <code>CounterManager</code> 概念。從長遠來看，使用單一類別將行不通，因為應用程式最終會與 Cloud Firestore 進行互動。但是，您不想在每次運行測試時都建立真實的記錄。為此，您需要一個抽象介面來定義應用程式應該如何表現。</p>
<p>再次打開 <code>counter_manager.dart</code>，並在檔案的頂部添加以下程式碼：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/app_state.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="language-markdown">定義操作</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">應用程式狀態所需的函式的介面。</span></span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">定義為抽象類別，以便測試可以在不</span></span></span><br><span class="line"><span class="comment">/// <span class="language-markdown">與 Firebase 通訊的版本上運行。</span></span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ICounterManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// <span class="language-markdown">任何 <span class="code">`CounterManager`</span> 都必須具有狀態的實例</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">物件。</span></span></span><br><span class="line">  AppState state;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">處理必須儲存新的點擊的事件。不需要</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">任何參數，因為它只會導致時間戳</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">持續存在。</span></span></span><br><span class="line">  <span class="keyword">void</span> increment();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步是更新 <code>CounterManager</code> 以顯式地從 <code>ICounterManager</code> 繼承。將其定義更新為以下內容：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterManager</span> <span class="keyword">implements</span> <span class="title">ICounterManager</span> </span>&#123;</span><br><span class="line">  AppState state = AppState();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> increment() =&gt; state = state.copyWith(<span class="built_in">DateTime</span>.now());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這個階段，我們的輔助程式碼看起來已經很好了，但是 <code>main.dart</code> 落後了。<code>main.dart</code> 中沒有 <code>ICounterManager</code> 的參考，而事實上，它是它應該知道的 <em>唯一</em> 的 <code>Manager</code> 類別。在 <code>main.dart</code> 中，更新並應用以下更改：</p>
<ol>
<li>將遺漏的匯入新增到 <code>main.dart</code> 的頂部：</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/app_state.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>將 <code>_MyHomePageState</code> 更新為以下內容：</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ICounterManager manager;</span><br><span class="line">  _MyHomePageState(&#123;<span class="meta">@required</span> <span class="keyword">this</span>.manager&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _incrementCounter() =&gt; setState(() =&gt; manager.increment());</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Text(<span class="string">&#x27;You have pushed the button this many times:&#x27;</span>),</span><br><span class="line">            Text(</span><br><span class="line">              <span class="comment">// 參考 `widget.manager` 而不是</span></span><br><span class="line">              <span class="comment">// `manager` 直接</span></span><br><span class="line">              <span class="string">&#x27;<span class="subst">$&#123;manager.state.count&#125;</span>&#x27;</span>,</span><br><span class="line">              style: Theme.of(context).textTheme.headline4,</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        <span class="comment">// 參考 `widget.manager` 而不是 `manager` 直接</span></span><br><span class="line">        onPressed: _incrementCounter,</span><br><span class="line">        tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此更改應該會移除 IDE 中 <code>_MyHomePageState</code> 的任何紅色波浪線，但是現在 <code>MyHomePage</code> 會抱怨，因為它的 <code>createState()</code> 方法沒有向 <code>_MyHomePageState</code> 提供所有必需的參數。您可以讓 <code>MyHomePage</code> 要求此變數，並將物件傳遞到它的基於狀態的類別，但是這可能會導致很長的 Widget 鏈，這些 Widget 會要求並傳遞它們實際上不在乎的物件，僅僅因為某些後代 Widget 要求它，而某些祖先 Widget 提供它。顯然，這需要一個更好的策略。</p>
<p>輸入： <a href="https://pub.dev/packages/provider">Provider</a></p>
<h3 id="使用-Provider-存取應用程式狀態"><a href="#使用-Provider-存取應用程式狀態" class="headerlink" title="使用 Provider 存取應用程式狀態"></a>使用 Provider 存取應用程式狀態</h3><p>Provider 是一个函式庫，它简化了 Flutter 的 <code>InheritedWidget</code> 模式的使用。Provider 允許頂級 Widget 在您的 Widget 樹中被所有後代 Widget 直接存取。這可能感覺像一個全域變數，但替代方案是將您的資料模型透過每個中間 Widget 傳遞下去，其中許多 Widget 本身並不感興趣。這種「變數 <a href="https://en.wikipedia.org/wiki/Bucket_brigade">桶式傳遞</a>」反模式會模糊您的應用程式中的關注點分離，並且會使重構佈局變得不必要地繁瑣。<code>InheritedWidget</code> 和 Provider 透過讓 Widget 樹中的任何位置的 Widget 都可以直接獲取所需的資料模型來避免這些問題。</p>
<p>要將 Provider 添加到您的應用程式，請打開 <code>pubspec.yaml</code>，並在 <code>dependencies</code> 區段中添加它：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">flutter:</span></span><br><span class="line">    <span class="attr">sdk:</span> <span class="string">flutter</span></span><br><span class="line">  <span class="comment"># Add this</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">^4.3.2+2</span></span><br></pre></td></tr></table></figure>

<p>在將該行添加到您的 <code>pubspec.yaml</code> 檔案後，運行以下命令將 Provider 下載到您的機器上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flutter pub get</span><br></pre></td></tr></table></figure>

<p>在 <code>main.dart</code> 旁邊，建立一個名為 <code>dependencies.dart</code> 的新檔案，並將以下程式碼複製到其中：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/counter_manager.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:provider/provider.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DependenciesProvider</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line">  DependenciesProvider(&#123;<span class="meta">@required</span> <span class="keyword">this</span>.child&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MultiProvider(</span><br><span class="line">      providers: [</span><br><span class="line">        Provider&lt;ICounterManager&gt;(create: (context) =&gt; CounterManager()),</span><br><span class="line">      ],</span><br><span class="line">      child: child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>關於 <code>DependenciesProvider</code> 的一些注意事項：</p>
<ol>
<li>它使用 <code>MultiProvider</code>，儘管它的列表中只有一個條目。從技術上講，這可以摺疊為一個單獨的 <code>Provider</code> Widget，但是實際的應用程式可能會包含許多這樣的服務，因此最好從一開始就使用 <code>MultiProvider</code>。</li>
<li>它需要一個子 Widget，它遵循 Flutter 中 Widget 組合的慣例，允許我們將此輔助程式碼插入 Widget 樹的頂部，從而使 <code>ICounterManager</code> 實例可用於整個應用程式。</li>
</ol>
<p>接下來，讓新的 <code>DependenciesProvider</code> 可用於整個應用程式。一種簡單的方法是使用它來包裝整個 <code>MaterialApp</code> Widget。打開 <code>main.dart</code>，並將 <code>main</code> 方法更新為如下所示：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(</span><br><span class="line">    DependenciesProvider(child: MyApp()),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您還需要在 <code>main.dart</code> 中匯入 <code>dependencies.dart</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/dependencies.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Consumer-Widget"><a href="#使用-Consumer-Widget" class="headerlink" title="使用 Consumer Widget"></a>使用 Consumer Widget</h3><p>您已經看到了 <code>MultiProvider</code> Widget 的作用（實際上它只是一種宣告一系列單獨的 <code>Provider</code> Widget 的更便捷方式）。下一步是透過使用 <a href="https://pub.dev/documentation/provider/latest/provider/Consumer-class.html">Consumer</a> Widget 來存取 <code>ICounterManager</code> 物件。</p>
<h3 id="依賴注入"><a href="#依賴注入" class="headerlink" title="依賴注入"></a>依賴注入</h3><p>如果您使用過 Cloud Firestore 撰寫過 Flutter 應用程式，那麼您可能會發現 Firestore 會讓單元測試更難撰寫。畢竟，當 Firestore 整合直接連接到您的 Widget 樹中時，您如何避免在資料庫中生成真實的記錄？</p>
<p>如果您有過這種體驗，那麼您就會發現將依賴項直接烘焙到 UI 程式碼中的局限性，在 Flutter 的情況下，UI 程式碼是 Widget。這就是依賴注入的強大之處：如果您的 Widget 接受輔助類別，這些輔助類別促進它們與依賴項（如 Firebase、設備的檔案系統，甚至網路請求）的互動，那麼您可以在測試期間提供模擬或偽造物件，而不是真實的類別。這讓您可以測試 Widget 是否按預期工作，而無需等待緩慢的網路請求、填滿檔案系統或產生 Firebase 計費費用。</p>
<p>要實現這一點，您需要重構應用程式，以便有一個清晰的點，讓測試可以注入模擬真實 Cloud Firestore 行為的偽造物件。幸運的是，<code>Consumer</code> Widget 非常適合此工作。</p>
<p>打開 <code>main.dart</code>，並將您的 <code>MyApp</code> Widget 替換為以下程式碼：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在頂部添加此匯入</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/firebase_waiter.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 將 `MyApp` 替換為此</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">        visualDensity: VisualDensity.adaptivePlatformDensity,</span><br><span class="line">      ),</span><br><span class="line">      home: FirebaseWaiter(</span><br><span class="line">        builder: (context) =&gt; Consumer&lt;ICounterManager&gt;(</span><br><span class="line">          builder: (context, manager, _child) =&gt; MyHomePage(</span><br><span class="line">            manager: manager,</span><br><span class="line">            title: <span class="string">&#x27;Flutter Demo Home Page&#x27;</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 這是放置您的啟動頁面的好地方！</span></span><br><span class="line">        waitingChild: Scaffold(</span><br><span class="line">          body: <span class="keyword">const</span> Center(child: CircularProgressIndicator()),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，在 <code>main.dart</code> 的頂部匯入 <code>Provider</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:provider/provider.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>將 <code>MyHomePage</code> 包裹在 <code>Consumer</code> Widget 中，允許您到達 Widget 樹中任意高的地方，以存取所需的資源，並將它們注入到需要它們的 Widget 中。在本教學中，這可能感覺沒有必要的工作，因為您只向上到達 <code>MyApp()</code> 一層，但是這在實際的生產應用程式中可能會透過數十個 Widget 延伸。</p>
<p>接下來，在同一個檔案中，對 <code>MyHomePage</code> 進行以下編輯：</p>
<blockquote>注意：如果在儲存此更改後您看到紅色螢幕，請不要擔心。需要更多編輯才能完成重構！</blockquote>

<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ICounterManager manager;</span><br><span class="line">  MyHomePage(&#123;<span class="meta">@required</span> <span class="keyword">this</span>.manager, Key key, <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _MyHomePageState createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個簡單的建構函式更改允許程式碼接受在先前程式碼片段中傳入的變數。</p>
<p>最後，透過對 <code>_MyHomePageState</code> 進行以下編輯來完成重構：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不再期望接收 `ICounterManager` 物件</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Text(<span class="string">&#x27;You have pushed the button this many times:&#x27;</span>),</span><br><span class="line">            Text(</span><br><span class="line">              <span class="comment">// 參考 `widget.manager` 而不是</span></span><br><span class="line">              <span class="comment">// `manager` 直接</span></span><br><span class="line">              <span class="string">&#x27;<span class="subst">$&#123;widget.manager.state.count&#125;</span>&#x27;</span>,</span><br><span class="line">              style: Theme.of(context).textTheme.headline4,</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        <span class="comment">// 參考 `widget.manager` 而不是 `manager` 直接</span></span><br><span class="line">        onPressed: () =&gt; setState(() =&gt; widget.manager.increment()),</span><br><span class="line">        tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>注意：您可能需要執行熱重新啟動來修復您的應用程式。</blockquote>

<p>如您所知，所有 State 物件都包含對它們在 Widget 屬性中包含的 StatefulWidget 包裹器的參考。因此，<code>_MyHomePageState</code> 物件可以透過將其程式碼從 <code>manager</code> 更改為 <code>widget.manager</code> 來存取這個新的 <code>manager</code> 屬性。</p>
<p>就這樣！您已經將依賴項注入到需要它們的 Widget 中，而不是硬編碼生產實作。</p>
<h3 id="測試應用程式"><a href="#測試應用程式" class="headerlink" title="測試應用程式"></a>測試應用程式</h3><p>如果您現在運行 <code>flutter test</code>，您將會看到測試套件不再通過。當您檢查 <code>widget_test.dart</code> 時，原因可能很清楚：測試函式實例化了 <code>MyApp()</code>，但沒有像您在真實程式碼中所做的那樣用 <code>DependenciesProvider</code> 包裹它，因此 <code>MyApp</code> 中添加的 <code>Consumer</code> Widget 無法在其祖先 Widget 中找到滿足的 <code>Provider</code>。</p>
<p>這就是依賴注入開始發揮作用的地方。您不必在測試中模仿生產程式碼（透過將 <code>MyApp</code> 包裹在 <code>DependenciesProvider</code> 中），而是更改測試以初始化 <code>MyHomePage</code>。將 <code>widget_test.dart</code> 更新為如下所示：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/counter_manager.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_test/flutter_test.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/main.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  testWidgets(<span class="string">&#x27;Counter increments smoke test&#x27;</span>, (WidgetTester tester) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">// Build our app and trigger a frame.</span></span><br><span class="line">    <span class="keyword">await</span> tester.pumpWidget(</span><br><span class="line">      MaterialApp(</span><br><span class="line">        home: MyHomePage(</span><br><span class="line">          manager: CounterManager(),</span><br><span class="line">          title: <span class="string">&#x27;Test Widget&#x27;</span>,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify that our counter starts at 0.</span></span><br><span class="line">    expect(find.text(<span class="string">&#x27;0&#x27;</span>), findsOneWidget);</span><br><span class="line">    expect(find.text(<span class="string">&#x27;1&#x27;</span>), findsNothing);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tap the &#x27;+&#x27; icon and trigger a frame.</span></span><br><span class="line">    <span class="keyword">await</span> tester.tap(find.byIcon(Icons.add));</span><br><span class="line">    <span class="keyword">await</span> tester.pump();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify that our counter has incremented.</span></span><br><span class="line">    expect(find.text(<span class="string">&#x27;0&#x27;</span>), findsNothing);</span><br><span class="line">    expect(find.text(<span class="string">&#x27;1&#x27;</span>), findsOneWidget);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>透過直接使用 <code>MyHomePage</code> 實例（以及一個包裝的 <code>MaterialApp</code> 來提供有效的 <code>BuildContext</code> 物件），您已經為自己建立了與 Cloud Firestore 的單元測試整合！</p>
<blockquote>注意：如果您在此部分遇到問題，請將您的更改與教學儲存庫中的 [這個提交](https://github.com/craiglabenz/flutter-firestore-counter/commit/bb68c1d3bb3746eca5f2dea16bd799c98ff232f1) 進行比較。</blockquote>

<h3 id="實作-Cloud-Firestore"><a href="#實作-Cloud-Firestore" class="headerlink" title="實作 Cloud Firestore"></a>實作 Cloud Firestore</h3><p>到目前為止，您已經移動了很多程式碼，並引入了幾個輔助類別，但是您還沒有更改應用程式的任何工作方式。好消息是，一切都已就位，可以開始撰寫一些了解 Cloud Firestore 的程式碼。首先，打開 <code>pubspec.yaml</code>，並添加以下兩行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="comment"># Add this</span></span><br><span class="line">  <span class="attr">cloud_firestore:</span> <span class="string">^0.14.1</span></span><br><span class="line">  <span class="comment"># Add this</span></span><br><span class="line">  <span class="attr">firebase_core:</span> <span class="string">^0.5.0</span></span><br><span class="line">  <span class="attr">flutter:</span></span><br><span class="line">    <span class="attr">sdk:</span> <span class="string">flutter</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">^4.3.2+2</span></span><br></pre></td></tr></table></figure>

<p>與往常一樣，當您對 <code>pubspec.yaml</code> 進行更改時（除非您的 IDE 替您完成此操作），請運行以下命令來下載和連結新的函式庫：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flutter pub get</span><br></pre></td></tr></table></figure>

<blockquote>注意：如果您尚未建立資料庫：請訪問 Firebase 主控台的專案，點擊 **Cloud Firestore** 標籤，然後點擊 **建立資料庫** 按鈕。</blockquote>

<h3 id="等待-Firebase"><a href="#等待-Firebase" class="headerlink" title="等待 Firebase"></a>等待 Firebase</h3><p>成功使用 Cloud Firestore 的第一步是初始化 Firebase，最關鍵的是 <em>在任務成功之前不要嘗試使用任何 Firebase 資源</em>。幸運的是，您可以使用一個 StatefulWidget 來包含該邏輯，而不是將該任務散佈在整個程式碼中。</p>
<p>在 <code>firebasecounter/lib/firebase_waiter.dart</code> 中建立一個新檔案，並添加以下程式碼：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebase_core/firebase_core.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FirebaseWaiter</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget <span class="built_in">Function</span>(BuildContext) builder;</span><br><span class="line">  <span class="keyword">final</span> Widget waitingChild;</span><br><span class="line">  <span class="keyword">const</span> FirebaseWaiter(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">    <span class="keyword">this</span>.waitingChild,</span><br><span class="line">    Key key,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _FirebaseWaiterState createState() =&gt; _FirebaseWaiterState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_FirebaseWaiterState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FirebaseWaiter</span>&gt; </span>&#123;</span><br><span class="line">  Future&lt;FirebaseApp&gt; firebaseReady;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    firebaseReady = Firebase.initializeApp();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) =&gt; FutureBuilder&lt;FirebaseApp&gt;(</span><br><span class="line">        future: firebaseReady,</span><br><span class="line">        builder: (context, snapshot) =&gt; <span class="comment">//&lt;</span></span><br><span class="line">            snapshot.connectionState == ConnectionState.done</span><br><span class="line">                ? widget.builder(context)</span><br><span class="line">                : widget.waitingChild,</span><br><span class="line">      );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此類別使用 Flutter 中的模式，利用特定 Widget 來完全處理應用程式中的特定依賴項或問題。要使用此 <code>FirebaseWaiter</code> Widget，請返回 <code>main.dart</code>，並對 <code>MyApp</code> 應用以下更改：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在頂部添加此匯入</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/firebase_waiter.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 將 `MyApp` 替換為此</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">        visualDensity: VisualDensity.adaptivePlatformDensity,</span><br><span class="line">      ),</span><br><span class="line">      home: FirebaseWaiter(</span><br><span class="line">        builder: (context) =&gt; Consumer&lt;ICounterManager&gt;(</span><br><span class="line">          builder: (context, manager, _child) =&gt; MyHomePage(</span><br><span class="line">            manager: manager,</span><br><span class="line">            title: <span class="string">&#x27;Flutter Demo Home Page&#x27;</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 這是放置您的啟動頁面的好地方！</span></span><br><span class="line">        waitingChild: Scaffold(</span><br><span class="line">          body: <span class="keyword">const</span> Center(child: CircularProgressIndicator()),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>現在，應用程式可以等待 Firebase 初始化，但可以在測試期間透過簡單地不使用 <code>FirebaseWaiter</code> 來跳過此過程。</p>
<blockquote>注意：上述更改可能會導致 Flutter 抱怨缺少 Firebase Plugin。如果出現這種情況，請完全關閉應用程式並重新開始除錯，這將允許 Flutter 安裝所有特定於平台的依賴項。</blockquote>

<h3 id="從-Cloud-Firestore-獲取資料"><a href="#從-Cloud-Firestore-獲取資料" class="headerlink" title="從 Cloud Firestore 獲取資料"></a>從 Cloud Firestore 獲取資料</h3><p>首先，透過將以下行添加到 <code>counter_manager.dart</code> 的頂部來匯入 Cloud Firestore：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:cloud_firestore/cloud_firestore.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>接下來，也在 <code>counter_manager.dart</code> 中，添加以下類別：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FirestoreCounterManager</span> <span class="keyword">implements</span> <span class="title">ICounterManager</span> </span>&#123;</span><br><span class="line">  AppState state;</span><br><span class="line">  <span class="keyword">final</span> FirebaseFirestore _firestore;</span><br><span class="line"></span><br><span class="line">FirestoreCounterManager()</span><br><span class="line">      : _firestore = FirebaseFirestore.instance,</span><br><span class="line">        state = <span class="keyword">const</span> AppState() &#123;</span><br><span class="line">    _watchCollection();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _watchCollection() &#123;</span><br><span class="line">    <span class="comment">// Part 1</span></span><br><span class="line">    _firestore</span><br><span class="line">        .collection(<span class="string">&#x27;clicks&#x27;</span>)</span><br><span class="line">        .snapshots()</span><br><span class="line">        <span class="comment">// Part 2</span></span><br><span class="line">        .listen((QuerySnapshot snapshot) &#123;</span><br><span class="line">      <span class="comment">// Part 3</span></span><br><span class="line">      <span class="keyword">if</span> (snapshot.docs.isEmpty) <span class="keyword">return</span>;</span><br><span class="line">      <span class="comment">// Part 4</span></span><br><span class="line">      <span class="keyword">final</span> _clicks = snapshot.docs</span><br><span class="line">          .map&lt;<span class="built_in">DateTime</span>&gt;((doc) &#123;</span><br><span class="line">            <span class="keyword">final</span> timestamp = doc.data()[<span class="string">&#x27;timestamp&#x27;</span>];</span><br><span class="line">            <span class="keyword">return</span> (timestamp != <span class="keyword">null</span>)</span><br><span class="line">                ? (timestamp <span class="keyword">as</span> Timestamp).toDate()</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="comment">// Part 5</span></span><br><span class="line">          .where((val) =&gt; val != <span class="keyword">null</span>)</span><br><span class="line">          <span class="comment">// Part 6</span></span><br><span class="line">          .toList();</span><br><span class="line">      <span class="comment">// Part 7</span></span><br><span class="line">      state = AppState(_clicks);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> increment() &#123;</span><br><span class="line">    _firestore.collection(<span class="string">&#x27;clicks&#x27;</span>).add(&#123;</span><br><span class="line">      <span class="string">&#x27;timestamp&#x27;</span>: FieldValue.serverTimestamp(),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>注意：此類別幾乎是正確的，但它會建立一個稍後會探討的錯誤。如果您現在將此程式碼添加到您的應用程式中並運行它，您將會看到行為與您想要的不同。請繼續閱讀，以了解詳細的解釋！</blockquote>

<p>這裡有很多事情正在發生，因此讓我們一步一步地進行。</p>
<p>首先，<code>FirestoreCounterManager</code> 實作了 <code>ICounterManager</code> 介面，因此它是生產 Widget 中可用的候選者。（最終，它將由 <code>DependenciesProvider</code> 提供！）<code>FirestoreCounterManager</code> 也維護了 <code>FirebaseFirestore</code> 的實例，它與生產資料庫的實時連接。<code>FirestoreCounterManager</code> 在初始化期間也調用 <code>_watchCollection()</code> 來建立與您關心的特定資料的連接，這就是事情變得有趣的地方。</p>
<p><code>_watchCollection()</code> 方法做了很多事情，值得單獨研究。</p>
<p>在第一部分中，<code>_watchCollection()</code> 調用 <code>_firestore.collection(&#39;clicks&#39;).snapshots()</code>. 這會返回一個流，每當集合中的資料發生更改時，就會更新。</p>
<p>在第二部分中，<code>_watchCollection()</code> 立即使用 <code>.listen()</code> 為該流註冊一個監聽器。傳遞給 <code>listen()</code> 的回調在資料發生任何更改時接收一個新的 <code>QuerySnapshot</code> 物件。此更新物件稱為快照，因為它反映了資料庫在某一時刻的正確狀態，但是，在任何時候都可能會被新的快照替換。</p>
<p>在第三部分中，回調會在集合為空時短路。</p>
<p>在第四部分中，回調會遍歷快照的文件，並返回一個包含混合的 null 和 DateTime 值的列表。</p>
<p>在第五部分中，回調會捨棄任何 null 值。這些是因將要修復的錯誤而產生的，但是這種防禦性程式設計在處理來自 Cloud Firestore 的資料時總是一個好主意。</p>
<p>在第六部分中，回調會解決 <code>map()</code> 返回的是迭代器而不是列表的事實。對迭代器調用 <code>.toList()</code> 會強制它處理整個集合，這正是您想要的。</p>
<p>最後，在第七部分中，回調會更新狀態物件。</p>
<p>要使用這個新的類別，請打開 <code>dependencies.dart</code>，並將其內容替換為以下內容：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:firebasecounter/counter_manager.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:provider/provider.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DependenciesProvider</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line">  DependenciesProvider(&#123;<span class="meta">@required</span> <span class="keyword">this</span>.child&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MultiProvider(</span><br><span class="line">      providers: [</span><br><span class="line">        <span class="comment">// `Provider` 已被 `ChangeNotifierProvider` 替換</span></span><br><span class="line">        ChangeNotifierProvider&lt;ICounterManager&gt;(</span><br><span class="line">          create: (context) =&gt; FirestoreCounterManager(),</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">      child: child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="診斷錯誤"><a href="#診斷錯誤" class="headerlink" title="診斷錯誤"></a>診斷錯誤</h3><p>如果您按原樣運行此程式碼，您 <em>幾乎</em> 會看到所需的行為。一切都看起來正確，除了螢幕始終落後於實際點擊次數一次。這是怎麼回事？</p>
<p>問題出現在初始計數器實作和當前基於流的實作之間的不相容性。浮動動作按鈕的 <code>onPressed</code> 處理器看起來像這樣：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">floatingActionButton: FloatingActionButton(</span><br><span class="line">  onPressed: () =&gt; setState(() =&gt; widget.manager.increment()),</span><br><span class="line">  ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>該處理器調用 <code>increment()</code> 並立即調用 <code>setState()</code>，這會告訴 Flutter 重新渲染。</p>
<p>當同步更新儲存在設備記憶體中的狀態時，這非常有效。但是，新的基於流的實作會啟動一系列異步步驟。這意味著，按原樣，程式碼會立即調用 <code>setState()</code>，然後僅在一個未知的未來時間點，管理員物件才會更新其狀態屬性。簡而言之，<code>onPressed</code> 處理器中的 <code>setState()</code> 調用過早了！更糟糕的是，因為所有這些活動都發生在回調內，深深地位於 <code>FirestoreCounterManager</code> 中，沒有任何 Widget 知道它，因此沒有任何 <code>Future</code> 可以讓 Widget 等待來解決問題。</p>
<p>這就像管理員物件需要能夠告訴 Widget 何時重新繪製一樣。 🤔</p>
<p>輸入： <a href="https://flutter.dev/docs/development/data-and-backend/state-mgmt/simple#changenotifier">ChangeNotifier</a></p>
<blockquote>注意：如果您在此部分遇到問題，請將您的更改與公開儲存庫中的 [這個提交](https://github.com/craiglabenz/flutter-firestore-counter/commit/3bf17b9bfac6c907b8650e1c668fa19b1160a51d) 進行比較。這些更改包括添加 Firebase 後產生的 Xcode 和 build.gradle 的更改，但是您可能可以專注於 Dart 檔案中的更改。
</blockquote>

<h3 id="使用-ChangeNotifier-重新渲染-Widget-樹"><a href="#使用-ChangeNotifier-重新渲染-Widget-樹" class="headerlink" title="使用 ChangeNotifier 重新渲染 Widget 樹"></a>使用 ChangeNotifier 重新渲染 Widget 樹</h3><p><code>ChangeNotifier</code> 是一個類別，它完全像它的名字所暗示的那樣做：當發生需要重新渲染的更改時，它會通知 Widget。</p>
<p>此過程的第一步是更新 <code>ICounterManager</code> 介面以擴展 <code>ChangeNotifier</code>。要執行此操作，請打開 <code>firebasecounter/lib/counter_manager.dart</code>，並對 <code>ICounterManager</code> 宣告進行以下更改：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 將 `extends ChangeNotifier` 添加到您的宣告中</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ICounterManager</span> <span class="keyword">extends</span> <span class="title">ChangeNotifier</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 類別中的所有內容都相同。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您尚未匯入 <code>flutter/material.dart</code>，請打開 <code>firebasecounter/lib/counter_manager.dart</code>，並將其添加到底部：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>您現在已準備好更新 <code>CounterManager</code> 和 <code>FirestoreCounterManager</code> 的定義。對於 <code>CounterManager</code>，請將其程式碼替換為以下實作：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterManager</span> <span class="keyword">extends</span> <span class="title">ChangeNotifier</span> <span class="keyword">implements</span> <span class="title">ICounterManager</span> </span>&#123;</span><br><span class="line">  AppState state = AppState();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">使用最近一次點擊的時間戳複製狀態物件，</span></span></span><br><span class="line">  <span class="comment">/// <span class="language-markdown">並告訴流更新。</span></span></span><br><span class="line">  <span class="keyword">void</span> increment() &#123;</span><br><span class="line">    state = state.copyWith(<span class="built_in">DateTime</span>.now());</span><br><span class="line">    <span class="comment">// 添加這行是 `ChangeNotifier` 告訴 Widget</span></span><br><span class="line">    <span class="comment">// 重新渲染自身的方式。</span></span><br><span class="line">    notifyListeners();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>對於 <code>FirestoreCounterManager</code>，應用以下更改：</p>
<ol>
<li>修改它的簽章以匹配以下內容：</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FirestoreCounterManager</span> <span class="keyword">extends</span> <span class="title">ChangeNotifier</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ICounterManager</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>將相同的 <code>notifyListeners();</code> 行添加到 <code>_watchCollection()</code> 的末尾，如下所示：</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _watchCollection() &#123;</span><br><span class="line">  _firestore</span><br><span class="line">      .collection(<span class="string">&#x27;clicks&#x27;</span>)</span><br><span class="line">      .snapshots()</span><br><span class="line">      .listen((QuerySnapshot snapshot) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 為了清晰起見，省略了 `_clicks` 的生成，但不要</span></span><br><span class="line">    <span class="comment">// 更改該程式碼。</span></span><br><span class="line"></span><br><span class="line">    state = AppState(_clicks);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 唯一必要的更改是添加這行！</span></span><br><span class="line">    notifyListeners();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您現在已經建立了讓 <code>ICounterManager</code> 類別告訴 Widget 何時重新渲染的必要更改的一半。管理員類別正在告訴 Widget 重新渲染，但是如果您現在運行您的應用程式，您將會看到 Widget 沒有在監聽。</p>
<p>要修復此問題，請打開 <code>dependencies.dart</code>，並將 <code>DependenciesProvider</code> 的實作替換為以下內容：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DependenciesProvider</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line">  DependenciesProvider(&#123;<span class="meta">@required</span> <span class="keyword">this</span>.child&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MultiProvider(</span><br><span class="line">      providers: [</span><br><span class="line">        <span class="comment">// `Provider` 已被 `ChangeNotifierProvider` 替換</span></span><br><span class="line">        ChangeNotifierProvider&lt;ICounterManager&gt;(</span><br><span class="line">          create: (context) =&gt; FirestoreCounterManager(),</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">      child: child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作為最後的更改，請從 <code>_MyHomePageState</code> 中移除 <code>setState()</code>，以跳過不必要的重新渲染。將其 <code>FloatingActionButton</code> 更新為如下所示：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">floatingActionButton: FloatingActionButton(</span><br><span class="line">  <span class="comment">// 移除 `setState()`！</span></span><br><span class="line">  onPressed: widget.manager.increment,</span><br><span class="line">  tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">  child: Icon(Icons.add),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>就這樣！<code>ChangeNotifierProvider</code> 確保 Widget 是「監聽器」，因此當 <code>ICounterManager</code> 類別調用 <code>notifyListeners()</code> 時，Widget 會收到重新渲染的訊息。</p>
<p>在這個階段，您應該能夠熱重新啟動您的應用程式，並看到所有內容都正常工作！</p>
<p>注意：如果您在此部分遇到問題，請將您的更改與公開儲存庫中的 <a href="https://github.com/craiglabenz/flutter-firestore-counter/commit/dfb584f62d094d8fdb6067ea11ff3551b9186aed">這個提交</a> 進行比較。</p>
<h3 id="修復測試"><a href="#修復測試" class="headerlink" title="修復測試"></a>修復測試</h3>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flutter/" rel="tag"># flutter</a>
              <a href="/tags/testing/" rel="tag"># testing</a>
              <a href="/tags/dependency-injection/" rel="tag"># dependency-injection</a>
              <a href="/tags/firebase/" rel="tag"># firebase</a>
              <a href="/tags/cloud-firestore/" rel="tag"># cloud-firestore</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/archives/9f00e92f.html" rel="prev" title="【文章翻譯】Performance testing on the web">
      <i class="fa fa-chevron-left"></i> 【文章翻譯】Performance testing on the web
    </a></div>
      <div class="post-nav-item">
    <a href="/archives/d6a738f8.html" rel="next" title="【文章翻譯】Flutter on the web, slivers, and platform-specific issues: user survey results from Q3 2020">
      【文章翻譯】Flutter on the web, slivers, and platform-specific issues: user survey results from Q3 2020 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%82%BA%E4%BB%80%E9%BA%BC%E9%81%B8%E6%93%87-Cloud-Firestore%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">為什麼選擇 Cloud Firestore？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%82%A8%E5%B0%87%E6%A7%8B%E5%BB%BA%E4%BB%80%E9%BA%BC%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">您將構建什麼？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%96%8B%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="nav-number">3.</span> <span class="nav-text">開始之前</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%82%A8%E9%81%87%E5%88%B0%E5%95%8F%E9%A1%8C"><span class="nav-number">4.</span> <span class="nav-text">如果您遇到問題</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84%E7%8B%80%E6%85%8B%E7%AE%A1%E7%90%86%E5%93%A1"><span class="nav-number">5.</span> <span class="nav-text">建立一個簡單的狀態管理員</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E7%BA%8C%E6%99%82%E9%96%93%E6%88%B3"><span class="nav-number">6.</span> <span class="nav-text">持續時間戳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Provider-%E5%AD%98%E5%8F%96%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E7%8B%80%E6%85%8B"><span class="nav-number">7.</span> <span class="nav-text">使用 Provider 存取應用程式狀態</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Consumer-Widget"><span class="nav-number">8.</span> <span class="nav-text">使用 Consumer Widget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B3%B4%E6%B3%A8%E5%85%A5"><span class="nav-number">9.</span> <span class="nav-text">依賴注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%AC%E8%A9%A6%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F"><span class="nav-number">10.</span> <span class="nav-text">測試應用程式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E4%BD%9C-Cloud-Firestore"><span class="nav-number">11.</span> <span class="nav-text">實作 Cloud Firestore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%89%E5%BE%85-Firebase"><span class="nav-number">12.</span> <span class="nav-text">等待 Firebase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%9E-Cloud-Firestore-%E7%8D%B2%E5%8F%96%E8%B3%87%E6%96%99"><span class="nav-number">13.</span> <span class="nav-text">從 Cloud Firestore 獲取資料</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%BA%E6%96%B7%E9%8C%AF%E8%AA%A4"><span class="nav-number">14.</span> <span class="nav-text">診斷錯誤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ChangeNotifier-%E9%87%8D%E6%96%B0%E6%B8%B2%E6%9F%93-Widget-%E6%A8%B9"><span class="nav-number">15.</span> <span class="nav-text">使用 ChangeNotifier 重新渲染 Widget 樹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E5%BE%A9%E6%B8%AC%E8%A9%A6"><span class="nav-number">16.</span> <span class="nav-text">修復測試</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rainvisitor</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">170</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">184</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rainvisitor</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
